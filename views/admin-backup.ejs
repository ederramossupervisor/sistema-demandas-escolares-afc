<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Sistema de Demandas Escolares</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card-header {
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }
        .btn-action {
            min-width: 120px;
        }
        .backup-file {
            border-left: 4px solid #0d6efd;
            padding-left: 10px;
            margin-bottom: 10px;
        }
        .backup-file .actions {
            opacity: 0;
            transition: opacity 0.3s;
        }
        .backup-file:hover .actions {
            opacity: 1;
        }
        .status-healthy { color: #198754; }
        .status-warning { color: #ffc107; }
        .status-critical { color: #dc3545; }
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            padding: 5px;
            border-bottom: 1px solid #dee2e6;
        }
        .log-entry.error { background-color: #f8d7da; }
        .log-entry.info { background-color: #d1ecf1; }
        .log-entry.warning { background-color: #fff3cd; }
    </style>
</head>
<body>
    <!-- Incluir a navbar -->
    <%- include('partials/navbar', { user, currentPage: 'admin-backup' }) %>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="h3 mb-4">
                    <i class="fas fa-database me-2"></i>Gerenciamento de Backup
                </h1>
                
                <!-- Mensagens de feedback -->
                <div id="alert-container"></div>

                <!-- Card de Status e Ações Rápidas -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-chart-line me-2"></i>Status do Sistema de Backup
                            </div>
                            <div class="card-body">
                                <div class="row" id="status-container">
                                    <div class="col-md-6">
                                        <p><strong>Último Backup:</strong> <span id="ultimo-backup">Carregando...</span></p>
                                        <p><strong>Próximo Backup:</strong> <span id="proximo-backup">Diariamente às 2h</span></p>
                                        <p><strong>Espaço em Disco:</strong> <span id="espaco-disco">Carregando...</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Total de Backups:</strong> <span id="total-backups">Carregando...</span></p>
                                        <p><strong>Tamanho Total:</strong> <span id="tamanho-total">Carregando...</span></p>
                                        <p><strong>Status do Agendador:</strong> <span id="status-agendador" class="badge bg-success">Ativo</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-bolt me-2"></i>Ações Rápidas
                            </div>
                            <div class="card-body text-center">
                                <button class="btn btn-primary btn-action mb-2" onclick="executarBackupManual()">
                                    <i class="fas fa-play me-1"></i> Executar Backup Agora
                                </button>
                                <button class="btn btn-warning btn-action mb-2" onclick="verificarEspacoDisco()">
                                    <i class="fas fa-hdd me-1"></i> Verificar Espaço em Disco
                                </button>
                                <button class="btn btn-info btn-action mb-2" onclick="carregarLogs()">
                                    <i class="fas fa-list me-1"></i> Recarregar Logs
                                </button>
                                <button class="btn btn-danger btn-action mb-2" onclick="limparLogsAntigos()">
                                    <i class="fas fa-trash me-1"></i> Limpar Logs Antigos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs para diferentes seções -->
                <ul class="nav nav-tabs mt-4" id="backupTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="database-tab" data-bs-toggle="tab" data-bs-target="#database" type="button" role="tab">
                            <i class="fas fa-database me-1"></i> Backups de Banco de Dados
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                            <i class="fas fa-file-alt me-1"></i> Backups de Relatórios
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                            <i class="fas fa-clipboard-list me-1"></i> Logs do Sistema
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-3 border border-top-0 rounded-bottom" id="backupTabsContent">
                    <!-- Tab de Banco de Dados -->
                    <div class="tab-pane fade show active" id="database" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Backups de Banco de Dados (MongoDB)</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="carregarBackups('database')">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                        <div id="database-list">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-2">Carregando backups...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab de Relatórios -->
                    <div class="tab-pane fade" id="reports" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Backups de Relatórios (PDF/Excel)</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="carregarBackups('reports')">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                        <div id="reports-list">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-2">Carregando relatórios...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab de Logs -->
                    <div class="tab-pane fade" id="logs" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Logs do Sistema de Backup</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="carregarBackups('logs')">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                        <div id="logs-list">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-2">Carregando logs...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar log -->
    <div class="modal fade" id="logModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logModalTitle">Detalhes do Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="logContent" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (para simplificar AJAX) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Função para mostrar mensagens
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            // Auto-remove após 5 segundos
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Carregar status do sistema
        async function carregarStatus() {
            try {
                const response = await fetch('/api/backup/estatisticas');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.estatisticas;
                    document.getElementById('ultimo-backup').textContent = 
                        stats.ultimoBackup ? new Date(stats.ultimoBackup.dataCriacao).toLocaleString('pt-BR') : 'Nenhum';
                    document.getElementById('total-backups').textContent = stats.totalBackups;
                    document.getElementById('tamanho-total').textContent = stats.tamanhoTotal;
                    
                    // Status do espaço
                    const espacoEl = document.getElementById('espaco-disco');
                    espacoEl.textContent = stats.tamanhoTotal;
                    espacoEl.className = `status-${stats.statusEspaco}`;
                    
                    // Status do agendador
                    const agendadorEl = document.getElementById('status-agendador');
                    agendadorEl.textContent = stats.ultimoBackup ? 'Ativo' : 'Nunou executado';
                    agendadorEl.className = `badge bg-${stats.ultimoBackup ? 'success' : 'warning'}`;
                }
            } catch (error) {
                console.error('Erro ao carregar status:', error);
            }
        }

        // Carregar lista de backups
        async function carregarBackups(tipo) {
            const containerId = `${tipo}-list`;
            const container = document.getElementById(containerId);
            
            // Mostrar loading
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/backup/listar');
                const data = await response.json();
                
                if (data.success) {
                    const backups = data.backups[tipo];
                    
                    if (backups.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">Nenhum backup encontrado.</div>';
                        return;
                    }
                    
                    let html = '';
                    backups.forEach(backup => {
                        const dataCriacao = new Date(backup.dataCriacao).toLocaleString('pt-BR');
                        
                        html += `
                        <div class="backup-file">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${backup.nome}</h6>
                                    <small class="text-muted">
                                        Criado em: ${dataCriacao} | Tamanho: ${backup.tamanho}
                                    </small>
                                </div>
                                <div class="actions">
                                    ${tipo === 'logs' ? `
                                        <button class="btn btn-sm btn-outline-info" onclick="verLog('${backup.nome}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline-danger" onclick="excluirBackup('${tipo}', '${backup.nome}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">Erro ao carregar backups.</div>';
                console.error('Erro ao carregar backups:', error);
            }
        }

        // Executar backup manual
        async function executarBackupManual() {
            if (!confirm('Deseja executar um backup manual agora? Esta operação pode levar alguns minutos.')) {
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Executando...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/backup/executar-manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Backup executado com sucesso!', 'success');
                    
                    // Recarregar status e listas
                    carregarStatus();
                    carregarBackups('database');
                    carregarBackups('reports');
                    carregarBackups('logs');
                } else {
                    showAlert(`Erro: ${data.message}`, 'danger');
                }
            } catch (error) {
                showAlert('Erro ao executar backup manual', 'danger');
                console.error('Erro:', error);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Excluir backup
        async function excluirBackup(tipo, nomeArquivo) {
            if (!confirm(`Tem certeza que deseja excluir o backup "${nomeArquivo}"? Esta ação não pode ser desfeita.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/backup/excluir/${tipo}/${encodeURIComponent(nomeArquivo)}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Backup excluído com sucesso!', 'success');
                    carregarBackups(tipo);
                    carregarStatus();
                } else {
                    showAlert(`Erro: ${data.message}`, 'danger');
                }
            } catch (error) {
                showAlert('Erro ao excluir backup', 'danger');
                console.error('Erro:', error);
            }
        }

        // Ver log
        async function verLog(nomeArquivo) {
            try {
                const response = await fetch(`/backups/logs/${nomeArquivo}`);
                const logText = await response.text();
                
                document.getElementById('logModalTitle').textContent = `Log: ${nomeArquivo}`;
                document.getElementById('logContent').textContent = logText;
                
                const modal = new bootstrap.Modal(document.getElementById('logModal'));
                modal.show();
            } catch (error) {
                showAlert('Erro ao carregar log', 'danger');
                console.error('Erro:', error);
            }
        }

        // Verificar espaço em disco
        async function verificarEspacoDisco() {
            // Implementação futura
            showAlert('Funcionalidade em desenvolvimento', 'info');
        }

        // Carregar logs
        function carregarLogs() {
            carregarBackups('logs');
            showAlert('Logs recarregados', 'info');
        }

        // Limpar logs antigos
        async function limparLogsAntigos() {
            if (!confirm('Deseja limpar todos os logs com mais de 30 dias?')) {
                return;
            }
            
            // Implementação futura
            showAlert('Funcionalidade em desenvolvimento', 'info');
        }

        // Inicializar a página
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar status inicial
            carregarStatus();
            
            // Carregar lista inicial de backups de banco de dados
            carregarBackups('database');
            
            // Configurar eventos das tabs
            const tabs = document.querySelectorAll('#backupTabs button[data-bs-toggle="tab"]');
            tabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', event => {
                    const target = event.target.getAttribute('data-bs-target').substring(1);
                    if (target === 'database' || target === 'reports' || target === 'logs') {
                        carregarBackups(target);
                    }
                });
            });
        });
    </script>
</body>
</html>