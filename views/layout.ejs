<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ConfiguraÃ§Ãµes para App PWA -->
    <meta name="application-name" content="Demandas Escolares">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Demandas">
    <meta name="description" content="Sistema de gerenciamento de demandas escolares">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#0d6efd">
    <meta name="theme-color" content="#0d6efd">
    
    <!-- Manifesto PWA -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Ãcones -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512x512.png">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- CSS prÃ³prio -->
    <link rel="stylesheet" href="/css/style.css">
    
    <title><%= title || 'Sistema de Demandas Escolares' %></title>
</head>
<body>
        <% if (typeof user !== 'undefined' && user) { %>
    <!-- ============================================
         ðŸŽ¯ LAYOUT COMPLETO COM NAVBAR + SIDEBAR
         ============================================ -->
    
    <!-- NAVBAR (partial) -->
    <%- include('partials/navbar') %>
    
    <!-- CONTEÃšDO PRINCIPAL COM LAYOUT 3+9 -->
    <div class="container-fluid">
        <div class="row">
            <!-- ðŸ“Š SIDEBAR (3 colunas) - SOMENTE DESKTOP -->
            <div class="col-lg-3 col-md-4 d-none d-md-block">
                <%- include('partials/sidebar') %>
            </div>
            
            <!-- ðŸŽ¯ CONTEÃšDO PRINCIPAL (9 colunas no desktop, 12 no mobile) -->
            <div class="col-lg-9 col-md-8 col-12">
                <main class="container-fluid py-3">
                    <% if (typeof content !== 'undefined') { %>
                        <%- content %>
                    <% } else if (typeof body !== 'undefined') { %>
                        <%- body %>
                    <% } %>
                </main>
            </div>
        </div>
    </div>
    
    <% } else { %>
    
    <!-- CONTEÃšDO PRINCIPAL COM LAYOUT 3+9 -->
    <div class="container-fluid">
        <div class="row">
            <!-- ðŸ“Š SIDEBAR (3 colunas) - SOMENTE DESKTOP -->
            <div class="col-lg-3 col-md-4 d-none d-md-block">
                <%- include('partials/sidebar') %>
            </div>
            
            <!-- ðŸŽ¯ CONTEÃšDO PRINCIPAL (9 colunas no desktop, 12 no mobile) -->
            <div class="col-lg-9 col-md-8 col-12">
                <main class="container-fluid py-3">
                    <% if (typeof content !== 'undefined') { %>
                        <%- content %>
                    <% } else if (typeof body !== 'undefined') { %>
                        <%- body %>
                    <% } %>
                </main>
            </div>
        </div>
    </div>
    
    <% } else { %>
        <!-- SE NÃƒO ESTIVER LOGADO, MOSTRA APENAS O CONTEÃšDO -->
        <main class="container mt-4">
            <% if (typeof content !== 'undefined') { %>
                <%- content %>
            <% } else if (typeof body !== 'undefined') { %>
                <%- body %>
            <% } %>
        </main>
    <% } %>
    
    <!-- Container para NotificaÃ§Ãµes Flash -->
    <div id="notifications-container"></div>
    
    <!-- BotÃ£o para instalar como App -->
    <div id="installPWA" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000; display: none;">
        <div class="toast show">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">
                    <i class="fas fa-mobile-alt me-2"></i>Instalar App
                </strong>
                <button type="button" class="btn-close btn-close-white" onclick="hideInstallButton()"></button>
            </div>
            <div class="toast-body">
                <p>Instale este app para acessar rapidamente!</p>
                <button class="btn btn-success w-100" onclick="installApp()">
                    <i class="fas fa-download me-2"></i>Instalar Agora
                </button>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Sistema de NotificaÃ§Ãµes - DEVE SER O ÃšLTIMO SCRIPT -->
    <script src="/notifications.js"></script>
    
    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('âœ… Service Worker registrado');
                    })
                    .catch(error => {
                        console.log('âŒ Erro:', error);
                    });
            });
        }
        
        // Controle do botÃ£o de instalaÃ§Ã£o
        let installPrompt = null;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            installPrompt = e;
            
            // Mostrar botÃ£o apÃ³s 3 segundos
            setTimeout(() => {
                if (installPrompt) {
                    document.getElementById('installPWA').style.display = 'block';
                }
            }, 3000);
        });
        
        // FunÃ§Ã£o para instalar
        function installApp() {
            if (installPrompt) {
                installPrompt.prompt();
                installPrompt.userChoice.then((choice) => {
                    if (choice.outcome === 'accepted') {
                        console.log('âœ… App instalado!');
                    }
                    installPrompt = null;
                    document.getElementById('installPWA').style.display = 'none';
                });
            }
        }
        
        // FunÃ§Ã£o para esconder o botÃ£o
        function hideInstallButton() {
            document.getElementById('installPWA').style.display = 'none';
        }
        
        // Verificar se jÃ¡ estÃ¡ instalado
        function isPWAInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone;
        }
        
        // Se jÃ¡ for PWA, esconder botÃ£o
        if (isPWAInstalled()) {
            document.getElementById('installPWA').style.display = 'none';
        }
        
        // ============================================
        // ðŸŽ¯ MELHORIAS PARA MOBILE
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“± Sistema carregado - Layout responsivo');
            
            // Melhorar experiÃªncia touch no mobile
            if (window.innerWidth <= 768) {
                // BotÃµes maiores para touch
                document.querySelectorAll('.btn, .list-group-item, .nav-link').forEach(element => {
                    element.style.minHeight = '44px';
                    element.style.display = 'flex';
                    element.style.alignItems = 'center';
                });
                
                // Inputs maiores (evita zoom no iOS)
                document.querySelectorAll('input, select, textarea').forEach(input => {
                    input.style.fontSize = '16px';
                });
            }
            
            // Fechar menu mobile ao clicar em um link
            document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        const navbarCollapse = document.getElementById('navbarComplete');
                        if (navbarCollapse.classList.contains('show')) {
                            const toggleBtn = document.querySelector('.navbar-toggler');
                            toggleBtn.click(); // Fecha o menu
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>