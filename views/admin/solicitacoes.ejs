<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <%- include('../partials/head', {title: 'Gerenciar Solicitações - Admin'}) %>
    <style>
        /* Estilos específicos para admin */
        .admin-container {
            padding: 20px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.pendente {
            border-top: 4px solid #ffc107;
        }
        
        .stat-card.aprovada {
            border-top: 4px solid #28a745;
        }
        
        .stat-card.rejeitada {
            border-top: 4px solid #dc3545;
        }
        
        .stat-card.expirada {
            border-top: 4px solid #6c757d;
        }
        
        .stat-icon {
            font-size: 30px;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filtros-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .solicitacao-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #ffc107;
            transition: all 0.3s;
        }
        
        .solicitacao-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .solicitacao-card.aprovada {
            border-left-color: #28a745;
        }
        
        .solicitacao-card.rejeitada {
            border-left-color: #dc3545;
        }
        
        .solicitacao-card.expirada {
            border-left-color: #6c757d;
        }
        
        .solicitacao-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .solicitacao-info h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .solicitacao-status {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-pendente {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-aprovada {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejeitada {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-expirada {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .solicitacao-detalhes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detalhe-item {
            margin-bottom: 10px;
        }
        
        .detalhe-label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .detalhe-valor {
            color: #6c757d;
            font-size: 15px;
        }
        
        .justificativa-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border-left: 3px solid #0096E1;
        }
        
        .acoes-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .btn-acao {
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-aprovar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
        }
        
        .btn-aprovar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-rejeitar {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
        }
        
        .btn-rejeitar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        
        .btn-detalhes {
            background: #6c757d;
            color: white;
            border: none;
        }
        
        .modal-aprovar .modal-body {
            padding: 30px;
        }
        
        .form-aprovar .form-group {
            margin-bottom: 20px;
        }
        
        .paginacao-container {
            display: flex;
            justify-content: center;
            margin-top: 40px;
        }
        
        .paginacao {
            display: flex;
            gap: 5px;
        }
        
        .page-link {
            padding: 8px 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            color: #0096E1;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .page-link:hover {
            background: #f8f9fa;
        }
        
        .page-link.active {
            background: #0096E1;
            color: white;
            border-color: #0096E1;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            color: #dee2e6;
        }
        
        @media (max-width: 768px) {
            .solicitacao-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .acoes-container {
                flex-direction: column;
            }
            
            .btn-acao {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <%- include('../partials/navbar') %>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('../partials/sidebar') %>
            
            <!-- Conteúdo Principal -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="admin-container">
                    
                    <!-- Cabeçalho -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1><i class="fas fa-user-cog me-2"></i>Gerenciar Solicitações de Cadastro</h1>
                        <a href="/testar-email" class="btn btn-outline-info">
                            <i class="fas fa-envelope me-2"></i>Testar Email
                        </a>
                    </div>
                    
                    <!-- Cards de Estatísticas -->
                    <div class="stats-cards">
                        <div class="stat-card pendente">
                            <div class="stat-icon text-warning">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-number"><%= totais.pendente %></div>
                            <div class="stat-label">Pendentes</div>
                        </div>
                        
                        <div class="stat-card aprovada">
                            <div class="stat-icon text-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-number"><%= totais.aprovada %></div>
                            <div class="stat-label">Aprovadas</div>
                        </div>
                        
                        <div class="stat-card rejeitada">
                            <div class="stat-icon text-danger">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-number"><%= totais.rejeitada %></div>
                            <div class="stat-label">Rejeitadas</div>
                        </div>
                        
                        <div class="stat-card expirada">
                            <div class="stat-icon text-secondary">
                                <i class="fas fa-hourglass-end"></i>
                            </div>
                            <div class="stat-number"><%= totais.expirada %></div>
                            <div class="stat-label">Expiradas</div>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="filtros-container">
                        <h5><i class="fas fa-filter me-2"></i>Filtros</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <div class="btn-group w-100" role="group">
                                        <a href="?status=todos&page=1" 
                                           class="btn <%= statusAtual === 'todos' ? 'btn-primary' : 'btn-outline-primary' %>">
                                            Todos
                                        </a>
                                        <a href="?status=pendente&page=1" 
                                           class="btn <%= statusAtual === 'pendente' ? 'btn-warning' : 'btn-outline-warning' %>">
                                            Pendentes
                                        </a>
                                        <a href="?status=aprovada&page=1" 
                                           class="btn <%= statusAtual === 'aprovada' ? 'btn-success' : 'btn-outline-success' %>">
                                            Aprovadas
                                        </a>
                                        <a href="?status=rejeitada&page=1" 
                                           class="btn <%= statusAtual === 'rejeitada' ? 'btn-danger' : 'btn-outline-danger' %>">
                                            Rejeitadas
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Itens por página</label>
                                    <select class="form-select" onchange="window.location.href='?status=<%= statusAtual %>&page=1&limit=' + this.value">
                                        <option value="5" <%= paginacao.limite === 5 ? 'selected' : '' %>>5 itens</option>
                                        <option value="10" <%= paginacao.limite === 10 ? 'selected' : '' %>>10 itens</option>
                                        <option value="20" <%= paginacao.limite === 20 ? 'selected' : '' %>>20 itens</option>
                                        <option value="50" <%= paginacao.limite === 50 ? 'selected' : '' %>>50 itens</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Solicitações -->
                    <% if (solicitacoes.length === 0) { %>
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>Nenhuma solicitação encontrada</h3>
                            <p>Não há solicitações 
                                <% if (statusAtual !== 'todos') { %>
                                    <%= statusAtual %>
                                <% } %>
                                no momento.
                            </p>
                        </div>
                    <% } else { %>
                        <% solicitacoes.forEach(function(solicitacao) { %>
                            <div class="solicitacao-card <%= solicitacao.status %>">
                                <div class="solicitacao-header">
                                    <div class="solicitacao-info">
                                        <h4><i class="fas fa-user me-2"></i><%= solicitacao.nome %></h4>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-envelope me-1"></i><%= solicitacao.email %>
                                        </p>
                                        <p class="text-muted mb-0">
                                            <i class="fas fa-calendar me-1"></i>
                                            Solicitado em: <%= new Date(solicitacao.dataSolicitacao).toLocaleDateString('pt-BR') %>
                                        </p>
                                    </div>
                                    
                                    <div>
                                        <span class="solicitacao-status status-<%= solicitacao.status %>">
                                            <i class="fas fa-circle me-1" style="font-size: 8px;"></i>
                                            <% if (solicitacao.status === 'pendente') { %>
                                                Pendente
                                            <% } else if (solicitacao.status === 'aprovada') { %>
                                                Aprovada
                                            <% } else if (solicitacao.status === 'rejeitada') { %>
                                                Rejeitada
                                            <% } else { %>
                                                Expirada
                                            <% } %>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="solicitacao-detalhes">
                                    <div class="detalhe-item">
                                        <div class="detalhe-label">
                                            <i class="fas fa-phone me-1"></i>Telefone
                                        </div>
                                        <div class="detalhe-valor"><%= solicitacao.telefone %></div>
                                    </div>
                                    
                                    <div class="detalhe-item">
                                        <div class="detalhe-label">
                                            <i class="fas fa-briefcase me-1"></i>Função
                                        </div>
                                        <div class="detalhe-valor"><%= solicitacao.funcao %></div>
                                    </div>
                                    
                                    <div class="detalhe-item">
                                        <div class="detalhe-label">
                                            <i class="fas fa-sitemap me-1"></i>Departamento
                                        </div>
                                        <div class="detalhe-valor">
                                            <% if (solicitacao.departamento === 'pedagogico') { %>
                                                Pedagógico
                                            <% } else if (solicitacao.departamento === 'secretaria') { %>
                                                Secretaria
                                            <% } else { %>
                                                Outro
                                            <% } %>
                                        </div>
                                    </div>
                                    
                                    <div class="detalhe-item">
                                        <div class="detalhe-label">
                                            <i class="fas fa-school me-1"></i>Escola
                                        </div>
                                        <div class="detalhe-valor"><%= solicitacao.escola %></div>
                                    </div>
                                </div>
                                
                                <% if (solicitacao.justificativa) { %>
                                    <div class="justificativa-box">
                                        <div class="detalhe-label mb-2">
                                            <i class="fas fa-comment me-1"></i>Justificativa
                                        </div>
                                        <div class="detalhe-valor"><%= solicitacao.justificativa %></div>
                                    </div>
                                <% } %>
                                
                                <% if (solicitacao.status === 'pendente') { %>
                                    <div class="acoes-container">
                                        <button class="btn btn-acao btn-aprovar" 
                                                onclick="abrirModalAprovar('<%= solicitacao._id %>', '<%= solicitacao.nome %>')">
                                            <i class="fas fa-check"></i>Aprovar Cadastro
                                        </button>
                                        
                                        <button class="btn btn-acao btn-rejeitar" 
                                                onclick="abrirModalRejeitar('<%= solicitacao._id %>', '<%= solicitacao.nome %>')">
                                            <i class="fas fa-times"></i>Rejeitar Solicitação
                                        </button>
                                        
                                        <button class="btn btn-acao btn-detalhes" 
                                                onclick="verDetalhes('<%= solicitacao._id %>')">
                                            <i class="fas fa-eye"></i>Ver Detalhes
                                        </button>
                                    </div>
                                <% } else if (solicitacao.motivoRejeicao) { %>
                                    <div class="alert alert-warning mt-3">
                                        <strong><i class="fas fa-exclamation-triangle me-2"></i>Motivo da Rejeição:</strong>
                                        <%= solicitacao.motivoRejeicao %>
                                    </div>
                                <% } %>
                                
                                <% if (solicitacao.usuarioCriado) { %>
                                    <div class="alert alert-success mt-3">
                                        <strong><i class="fas fa-user-check me-2"></i>Usuário Criado:</strong>
                                        <%= solicitacao.usuarioCriado.nome %> (<%= solicitacao.usuarioCriado.email %>)
                                        <span class="badge bg-<%= solicitacao.usuarioCriado.ativo ? 'success' : 'secondary' %> ms-2">
                                            <%= solicitacao.usuarioCriado.ativo ? 'Ativo' : 'Inativo' %>
                                        </span>
                                    </div>
                                <% } %>
                            </div>
                        <% }); %>
                        
                        <!-- Paginação -->
                        <% if (paginacao.paginas > 1) { %>
                            <div class="paginacao-container">
                                <div class="paginacao">
                                    <% if (paginacao.pagina > 1) { %>
                                        <a href="?status=<%= statusAtual %>&page=<%= paginacao.pagina - 1 %>&limit=<%= paginacao.limite %>" 
                                           class="page-link">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    <% } %>
                                    
                                    <% for (let i = 1; i <= paginacao.paginas; i++) { %>
                                        <a href="?status=<%= statusAtual %>&page=<%= i %>&limit=<%= paginacao.limite %>" 
                                           class="page-link <%= i === paginacao.pagina ? 'active' : '' %>">
                                            <%= i %>
                                        </a>
                                    <% } %>
                                    
                                    <% if (paginacao.pagina < paginacao.paginas) { %>
                                        <a href="?status=<%= statusAtual %>&page=<%= paginacao.pagina + 1 %>&limit=<%= paginacao.limite %>" 
                                           class="page-link">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    <% } %>
                                </div>
                            </div>
                        <% } %>
                    <% } %>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modal Aprovar -->
    <div class="modal fade" id="modalAprovar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-check me-2"></i>Aprovar Cadastro
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-aprovar">
                    <form id="formAprovar" class="form-aprovar">
                        <input type="hidden" id="solicitacaoIdAprovar">
                        
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Você está prestes a aprovar o cadastro de <strong id="nomeUsuarioAprovar"></strong>.
                                O usuário receberá uma senha temporária por email.
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="tipoUsuario" class="form-label">
                                            <i class="fas fa-user-tag me-1"></i>Tipo de Usuário *
                                        </label>
                                        <select class="form-select" id="tipoUsuario" name="tipo" required>
                                            <option value="comum">Usuário Comum</option>
                                            <option value="gestao">Gestão Escolar</option>
                                            <option value="supervisao">Supervisão</option>
                                            <option value="administrador">Administrador</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            Defina o nível de acesso do usuário
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="departamentoUsuario" class="form-label">
                                            <i class="fas fa-sitemap me-1"></i>Departamento *
                                        </label>
                                        <select class="form-select" id="departamentoUsuario" name="departamento" required>
                                            <option value="pedagogico">Pedagógico</option>
                                            <option value="secretaria">Secretaria</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="escolasUsuario" class="form-label">
                                    <i class="fas fa-school me-1"></i>Escola/Unidade *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="escolasUsuario" 
                                       name="escolas" 
                                       required
                                       placeholder="Digite a escola do usuário">
                                <small class="form-text text-muted">
                                    Escola onde o usuário atua
                                </small>
                            </div>
                            
                            <div class="alert alert-warning mt-4">
                                <h6><i class="fas fa-exclamation-triangle me-2"></i>Importante</h6>
                                <ul class="mb-0">
                                    <li>Uma senha temporária será gerada automaticamente</li>
                                    <li>O usuário receberá um email com as credenciais</li>
                                    <li>No primeiro acesso, ele será obrigado a alterar a senha</li>
                                    <li>O usuário ficará ativo imediatamente após a aprovação</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check me-2"></i>Aprovar e Cadastrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Rejeitar -->
    <div class="modal fade" id="modalRejeitar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="fas fa-user-times me-2"></i>Rejeitar Solicitação
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="formRejeitar">
                    <input type="hidden" id="solicitacaoIdRejeitar">
                    
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Você está prestes a rejeitar a solicitação de <strong id="nomeUsuarioRejeitar"></strong>.
                        </div>
                        
                        <div class="form-group">
                            <label for="motivoRejeicao" class="form-label">
                                <i class="fas fa-comment-dots me-1"></i>Motivo da Rejeição *
                            </label>
                            <textarea class="form-control" 
                                      id="motivoRejeicao" 
                                      name="motivo" 
                                      rows="4" 
                                      required
                                      minlength="5"
                                      placeholder="Explique o motivo da rejeição (mínimo 5 caracteres)..."></textarea>
                            <small class="form-text text-muted">
                                Este motivo será enviado por email ao solicitante.
                            </small>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-ban me-2"></i>Confirmar Rejeição
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
            <!-- Scripts -->
    <script>
        // Obter dados do servidor via atributos data
        const serverData = document.getElementById('serverData').dataset;
        const totalPendentes = parseInt(serverData.totalPendentes) || 0;
        const statusAtualJS = serverData.statusAtual || 'todos';
        
        // Função para abrir modal de aprovação
        function abrirModalAprovar(id, nome) {
            document.getElementById('solicitacaoIdAprovar').value = id;
            document.getElementById('nomeUsuarioAprovar').textContent = nome;
            
            const modal = new bootstrap.Modal(document.getElementById('modalAprovar'));
            modal.show();
        }
        
        // Função para abrir modal de rejeição
        function abrirModalRejeitar(id, nome) {
            document.getElementById('solicitacaoIdRejeitar').value = id;
            document.getElementById('nomeUsuarioRejeitar').textContent = nome;
            
            const modal = new bootstrap.Modal(document.getElementById('modalRejeitar'));
            modal.show();
        }
        
        // Função para ver detalhes
        function verDetalhes(id) {
            fetch(`/admin/solicitacoes/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const solicitacao = data.solicitacao;
                        alert(`Detalhes da Solicitação:\n\n` +
                              `Nome: ${solicitacao.nome}\n` +
                              `Email: ${solicitacao.email}\n` +
                              `Status: ${solicitacao.status}\n` +
                              `Data: ${new Date(solicitacao.dataSolicitacao).toLocaleString('pt-BR')}\n` +
                              `Justificativa: ${solicitacao.justificativa}`);
                    } else {
                        alert('Erro ao buscar detalhes: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao buscar detalhes da solicitação');
                });
        }
        
        // Formulário de aprovação
        document.getElementById('formAprovar').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('solicitacaoIdAprovar').value;
            const formData = new FormData(this);
            
            const btnSubmit = this.querySelector('button[type="submit"]');
            const originalText = btnSubmit.innerHTML;
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
            
            try {
                const response = await fetch(`/admin/solicitacoes/${id}/aprovar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(Object.fromEntries(formData))
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Fechar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalAprovar')).hide();
                    
                    // Mostrar notificação
                    if (window.showNotification) {
                        showNotification('success', 'Solicitação aprovada com sucesso!');
                    }
                    
                    // Recarregar página após 2 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Erro ao aprovar:', error);
                alert('Erro ao aprovar solicitação: ' + error.message);
                
                // Reativar botão
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = originalText;
            }
        });
        
        // Formulário de rejeição
        document.getElementById('formRejeitar').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('solicitacaoIdRejeitar').value;
            const motivo = document.getElementById('motivoRejeicao').value;
            
            if (!motivo || motivo.trim().length < 5) {
                alert('Por favor, forneça um motivo válido (mínimo 5 caracteres)');
                return;
            }
            
            const btnSubmit = this.querySelector('button[type="submit"]');
            const originalText = btnSubmit.innerHTML;
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
            
            try {
                const response = await fetch(`/admin/solicitacoes/${id}/rejeitar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ motivo: motivo.trim() })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Fechar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalRejeitar')).hide();
                    
                    // Mostrar notificação
                    if (window.showNotification) {
                        showNotification('warning', 'Solicitação rejeitada com sucesso!');
                    }
                    
                    // Recarregar página após 2 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Erro ao rejeitar:', error);
                alert('Erro ao rejeitar solicitação: ' + error.message);
                
                // Reativar botão
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = originalText;
            }
        });
        
        // Inicializar tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Auto-refresh para solicitações pendentes (apenas se houver pendentes)
        if (totalPendentes > 0 && statusAtualJS === 'pendente') {
            setTimeout(() => {
                window.location.reload();
            }, 30000); // 30 segundos
        }
    </script>
</body>
</html>