<!-- views/admin/backup.ejs -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <style>
    /* Melhorias para tabela de backups */
    .table-backups tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .backup-actions .btn {
        min-width: 40px;
    }
    
    /* Badges personalizados */
    .badge-database { background-color: #0d6efd; }
    .badge-logs { background-color: #ffc107; color: #000; }
    .badge-reports { background-color: #17a2b8; }
    
    /* Progresso de download */
    .download-progress {
        width: 100px;
        display: inline-block;
        margin-right: 10px;
        vertical-align: middle;
    }
    
    /* Status dos backups */
    .status-completo { color: #198754; }
    .status-falha { color: #dc3545; }
    .status-processando { color: #0dcaf0; }
    
    /* ============================================
       üéØ CORRE√á√ÉO SIMPLIFICADA PARA MODAL
       ============================================ */
    
    /* Garantir que o modal fique vis√≠vel */
    #modalNovoBackup {
        display: none; /* Bootstrap controla isso */
        z-index: 1060;
    }
    
    #modalNovoBackup.show {
        display: block !important;
    }
    
    /* Centralizar o modal */
    #modalNovoBackup .modal-dialog {
        max-width: 500px;
        margin: 1.75rem auto;
    }
    
    /* Prevenir flash de scrollbar */
    .modal {
        overflow: hidden !important;
    }
    
    /* Garantir que o conte√∫do do modal tenha altura fixa */
    #modalNovoBackup .modal-content {
        max-height: 80vh;
        overflow-y: auto;
    }
    
    /* Manter footer vis√≠vel */
    #modalNovoBackup .modal-footer {
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 1px solid #dee2e6;
        z-index: 1;
    }
    
    /* Backdrop correto */
    .modal-backdrop.show {
        opacity: 0.5;
        z-index: 1050;
    }
    
    /* Responsividade */
    @media (max-width: 576px) {
        #modalNovoBackup .modal-dialog {
            margin: 0.5rem;
            max-width: calc(100% - 1rem);
        }
    }
    
    /* Estilo para modal de progresso */
    #modalProgresso .modal-dialog {
        max-width: 400px;
    }
    
    .progress {
        height: 25px;
    }
    </style>
    <%- include('../partials/head', { title: 'Gerenciamento de Backups' }) %>
</head>
<body>
    <!-- Verificar se usu√°rio est√° logado -->
    <% if (user) { %>
        <!-- NAVBAR -->
        <%- include('../partials/navbar', { currentPage: 'admin-backups' }) %>
        
        <div class="container-fluid">
            <div class="row">
                <!-- SIDEBAR -->
                <div class="col-lg-3 col-md-4 d-none d-md-block">
                    <%- include('../partials/sidebar', { currentPage: 'admin-backups' }) %>
                </div>
                
                <!-- CONTE√öDO PRINCIPAL -->
                <div class="col-lg-9 col-md-8 col-12">
                    <main class="container-fluid py-3">
                        <!-- ========== CONTE√öDO DA P√ÅGINA BACKUP ========== -->
                        
                        <!-- T√çTULO -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h1 class="h3 mb-0">
                                    <i class="fas fa-database me-2 text-primary"></i>Backups do Sistema
                                </h1>
                                <p class="text-muted mb-0">Gerencie e execute backups do banco de dados</p>
                            </div>
                            <button class="btn btn-primary" onclick="executarBackupManual()">
                                <i class="fas fa-plus-circle me-2"></i>Novo Backup
                            </button>
                        </div>

                        <!-- FILTROS R√ÅPIDOS (opcional) -->
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="filtrarPorTipo('todos')">
                                Todos
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="filtrarPorTipo('database')">
                                Banco de Dados
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="filtrarPorTipo('logs')">
                                Logs
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="filtrarPorTipo('reports')">
                                Relat√≥rios
                            </button>
                        </div>

                        <!-- CARDS DE ESTAT√çSTICAS -->
                        <div class="row mb-4" id="cardsEstatisticas">
                            <!-- Card 1: Total Backups -->
                            <div class="col-xl-3 col-lg-6 mb-3">
                                <div class="card bg-primary bg-gradient text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="card-title mb-2">Total de Backups</h6>
                                                <h2 id="totalBackups" class="mb-0">0</h2>
                                            </div>
                                            <i class="fas fa-database fa-3x opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 2: Espa√ßo Usado -->
                            <div class="col-xl-3 col-lg-6 mb-3">
                                <div class="card bg-success bg-gradient text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="card-title mb-2">Espa√ßo Usado</h6>
                                                <h2 id="espacoTotal" class="mb-0">0 MB</h2>
                                            </div>
                                            <i class="fas fa-hdd fa-3x opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 3: √öltimo Backup -->
                            <div class="col-xl-3 col-lg-6 mb-3">
                                <div class="card bg-warning bg-gradient text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="card-title mb-2">√öltimo Backup</h6>
                                                <h2 id="ultimoBackup" class="mb-0">-</h2>
                                                <small id="tempoUltimoBackup" class="opacity-75">Nenhum backup</small>
                                            </div>
                                            <i class="fas fa-history fa-3x opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 4: Pr√≥ximo Backup -->
                            <div class="col-xl-3 col-lg-6 mb-3">
                                <div class="card bg-info bg-gradient text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="card-title mb-2">Pr√≥ximo Backup</h6>
                                                <h2 id="proximoBackup" class="mb-0">02:00</h2>
                                                <small class="opacity-75">Agendado di√°rio</small>
                                            </div>
                                            <i class="fas fa-clock fa-3x opacity-50"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TABELA DE BACKUPS -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2 text-primary"></i>Backups Dispon√≠veis
                                </h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="atualizarTudo()" title="Atualizar">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger d-none" id="btnExcluirVarios" onclick="excluirSelecionados()">
                                        <i class="fas fa-trash me-1"></i>Excluir Selecionados
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover table-striped">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="50">
                                                    <input type="checkbox" id="checkTodos" class="form-check-input" 
                                                           onchange="selecionarTodos(this.checked)">
                                                </th>
                                                <th>Nome do Arquivo</th>
                                                <th>Tipo</th>
                                                <th>Data de Cria√ß√£o</th>
                                                <th>Tamanho</th>
                                                <th width="120">A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabelaBackups">
                                            <!-- LINHA DE CARREGAMENTO -->
                                            <tr id="loadingRow">
                                                <td colspan="6" class="text-center py-5">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Carregando...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">Carregando backups...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- MENSAGEM SEM BACKUPS -->
                                <div id="semBackups" class="text-center py-4 d-none">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Nenhum backup encontrado</h5>
                                    <p class="text-muted">Execute seu primeiro backup clicando no bot√£o "Novo Backup"</p>
                                </div>
                            </div>
                        </div>

                        <!-- INFORMA√á√ïES DO SISTEMA -->
                        <div class="card shadow-sm mt-4">
                            <div class="card-header bg-white py-3">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle me-2 text-info"></i>Informa√ß√µes do Sistema
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="mb-3">Agendamento Autom√°tico</h6>
                                        <p><i class="fas fa-clock text-info me-2"></i>Backups autom√°ticos: <strong>Diariamente √†s 02:00</strong></p>
                                        <p><i class="fas fa-folder text-success me-2"></i>Pasta de backup: <code>/backups/</code></p>
                                        <p><i class="fas fa-calendar-alt text-warning me-2"></i>Reten√ß√£o: <strong>30 dias</strong></p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="mb-3">Recomenda√ß√µes</h6>
                                        <ul class="mb-0">
                                            <li>Mantenha pelo menos os √∫ltimos 7 dias de backup</li>
                                            <li>Fa√ßa backup manual antes de atualiza√ß√µes importantes</li>
                                            <li>Verifique regularmente o espa√ßo em disco</li>
                                            <li>Armazene backups externamente para seguran√ßa</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ========== FIM CONTE√öDO ========== -->
                    </main>
                </div>
            </div>
        </div>
        
        <!-- FOOTER -->
        <%- include('../partials/footer') %>
        
    <% } else { %>
        <!-- SE N√ÉO ESTIVER LOGADO -->
        <div class="container mt-5">
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h4>Acesso Negado</h4>
                <p>Voc√™ precisa estar logado para acessar esta p√°gina.</p>
                <a href="/login" class="btn btn-primary">Fazer Login</a>
            </div>
        </div>
    <% } %>
    
    <!-- MODAIS -->
    
    <!-- MODAL CONFIRMAR EXCLUS√ÉO -->
    <div class="modal fade" id="modalExcluir" tabindex="-1" aria-labelledby="modalExcluirLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalExcluirLabel">
                        <i class="fas fa-trash-alt text-danger me-2"></i>Confirmar Exclus√£o
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir o backup <strong id="nomeBackupExcluir" class="text-danger">[NOME]</strong>?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Esta a√ß√£o n√£o pode ser desfeita. O arquivo ser√° permanentemente exclu√≠do.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmarExclusao()">
                        <i class="fas fa-trash me-1"></i>Excluir Permanentemente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL NOVO BACKUP (VERS√ÉO SIMPLIFICADA) -->
    <div class="modal fade" id="modalNovoBackup" tabindex="-1" aria-labelledby="modalNovoBackupLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNovoBackupLabel">
                        <i class="fas fa-database text-primary me-2"></i>Executar Backup Manual
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nomeBackup" class="form-label">Nome do Backup (opcional)</label>
                        <input type="text" class="form-control" id="nomeBackup" placeholder="backup_emergencial_2024">
                        <small class="form-text text-muted">Deixe em branco para usar data/hora autom√°tica</small>
                    </div>
                    <div class="mb-3">
                        <label for="descricaoBackup" class="form-label">Descri√ß√£o (opcional)</label>
                        <textarea class="form-control" id="descricaoBackup" rows="3" 
                                placeholder="Ex: Backup antes da atualiza√ß√£o do sistema..."></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Aten√ß√£o:</strong> O backup pode levar alguns minutos dependendo do tamanho do banco de dados.
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="iniciarBackup()">
                        <i class="fas fa-play-circle me-1"></i>Executar Backup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE PROGRESSO -->
    <div class="modal fade" id="modalProgresso" tabindex="-1" aria-labelledby="modalProgressoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProgressoLabel">
                        <i class="fas fa-cog fa-spin text-primary me-2"></i>Criando Backup
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="progress mb-3">
                        <div id="barraProgresso" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="mensagemProgresso" class="mb-0">Iniciando processo de backup...</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-warning" onclick="cancelarBackup()">
                        <i class="fas fa-stop-circle me-1"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <%- include('../partials/scripts') %>
    
    <!-- JAVASCRIPT ESPEC√çFICO PARA BACKUP -->
    <script>
        // ============================================
        // VARI√ÅVEIS GLOBAIS
        // ============================================
        let backupsSelecionados = [];
        let backupAtualParaExcluir = null;
        let processoBackupAtivo = false;

        // ============================================
        // FUN√á√ïES AUXILIARES
        // ============================================
        // FILTRAR POR TIPO
        function filtrarPorTipo(tipo) {
            const linhas = document.querySelectorAll('#tabelaBackups tr');
            
            linhas.forEach(linha => {
                if (tipo === 'todos') {
                    linha.style.display = '';
                } else {
                    const tipoLinha = linha.querySelector('.badge').textContent.toLowerCase();
                    if (tipoLinha.includes(tipo)) {
                        linha.style.display = '';
                    } else {
                        linha.style.display = 'none';
                    }
                }
            });
            
            mostrarNotificacao(`Mostrando backups do tipo: ${tipo}`, 'info');
        }
        
        // FORMATAR TAMANHO EM BYTES
        function formatarTamanho(bytes) {
            if (bytes === 0 || !bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // FORMATAR DATA
        function formatarData(dataString) {
            if (!dataString) return '-';
            try {
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-BR') + ' ' + 
                       data.toLocaleTimeString('pt-BR').substring(0, 5);
            } catch {
                return dataString;
            }
        }

        // CALCULAR TEMPO RELATIVO
        function tempoRelativo(dataString) {
            if (!dataString) return '-';
            try {
                const agora = new Date();
                const data = new Date(dataString);
                const diff = agora - data;
                const minutos = Math.floor(diff / 60000);
                const horas = Math.floor(minutos / 60);
                const dias = Math.floor(horas / 24);
                
                if (dias > 0) return `${dias} dia${dias > 1 ? 's' : ''} atr√°s`;
                if (horas > 0) return `${horas} hora${horas > 1 ? 's' : ''} atr√°s`;
                if (minutos > 0) return `${minutos} minuto${minutos > 1 ? 's' : ''} atr√°s`;
                return 'agora mesmo';
            } catch {
                return '-';
            }
        }

        // MOSTRAR NOTIFICA√á√ÉO
        function mostrarNotificacao(mensagem, tipo = 'info') {
            if (typeof showToast === 'function') {
                showToast(mensagem, tipo);
            } else if (typeof mostrarNotificacaoFlash === 'function') {
                mostrarNotificacaoFlash(mensagem, tipo);
            } else {
                // Fallback simples
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
                alertDiv.style.zIndex = '9999';
                alertDiv.innerHTML = `
                    ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 3000);
            }
        }
        
        // ============================================
        // FUN√á√ïES PRINCIPAIS
        // ============================================

        // CARREGAR ESTAT√çSTICAS - VERS√ÉO ATUALIZADA
        async function carregarEstatisticas() {
            try {
                const resposta = await fetch('/api/backup/estatisticas');
                if (!resposta.ok) throw new Error('Erro na requisi√ß√£o');
                
                const dados = await resposta.json();
                if (dados.success) {
                    const stats = dados.estatisticas;
                    
                    // Se vierem estat√≠sticas da API de listar tamb√©m
                    if (dados.estatisticas) {
                        atualizarCardsComEstatisticas(dados.estatisticas);
                    } else {
                        // Usar as da rota /estatisticas
                        atualizarCardsComEstatisticas(stats);
                    }
                }
            } catch (erro) {
                console.error('Erro ao carregar estat√≠sticas:', erro);
                // Manter valores padr√£o
            }
        }

        // FUN√á√ÉO PARA ATUALIZAR OS CARDS
        function atualizarCardsComEstatisticas(stats) {
            // Card 1: Total Backups
            if (stats.totalBackups !== undefined) {
                document.getElementById('totalBackups').textContent = stats.totalBackups;
            }
            
            // Card 2: Espa√ßo Total
            if (stats.espacoTotal) {
                document.getElementById('espacoTotal').textContent = stats.espacoTotal;
            } else if (stats.totalSize) {
                document.getElementById('espacoTotal').textContent = formatarTamanho(stats.totalSize);
            }
            
            // Card 3: √öltimo Backup
            if (stats.ultimoBackup) {
                const dataUltimo = stats.ultimoBackup.dataCriacao || stats.ultimoBackup;
                if (dataUltimo) {
                    document.getElementById('ultimoBackup').textContent = formatarData(dataUltimo).split(' ')[0];
                    document.getElementById('tempoUltimoBackup').textContent = tempoRelativo(dataUltimo);
                }
            }
        }

        // CARREGAR LISTA DE BACKUPS - VERS√ÉO FINAL OTIMIZADA
        async function carregarBackups() {
            console.log('üîÑ Carregando lista de backups...');
            
            try {
                const resposta = await fetch('/api/backup/listar');
                console.log('üì° Status:', resposta.status);
                
                if (!resposta.ok) throw new Error(`HTTP ${resposta.status}`);
                
                const dados = await resposta.json();
                console.log('üì¶ API response:', dados);
                
                if (dados.success && dados.backups) {
                    // Juntar todos os backups de todos os tipos
                    let todosBackups = [];
                    
                    for (const tipo in dados.backups) {
                        if (Array.isArray(dados.backups[tipo]) && dados.backups[tipo].length > 0) {
                            console.log(`üìÇ ${tipo}: ${dados.backups[tipo].length} backup(s)`);
                            
                            // Adicionar tipo a cada backup
                            const backupsComTipo = dados.backups[tipo].map(backup => ({
                                ...backup,
                                tipo: tipo
                            }));
                            
                            todosBackups = todosBackups.concat(backupsComTipo);
                        }
                    }
                    
                    console.log(`‚úÖ Total: ${todosBackups.length} backup(s)`);
                    mostrarBackups(todosBackups);
                    
                    // Se vierem estat√≠sticas, atualizar tamb√©m
                    if (dados.estatisticas) {
                        atualizarCardsComEstatisticas(dados.estatisticas);
                    }
                    
                } else {
                    throw new Error(dados.message || 'Erro na API');
                }
            } catch (erro) {
                console.error('‚ùå Erro ao carregar backups:', erro);
                
                const tbody = document.getElementById('tabelaBackups');
                const loadingRow = document.getElementById('loadingRow');
                
                if (loadingRow) loadingRow.remove();
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <h6>N√£o foi poss√≠vel carregar os backups</h6>
                                <p class="small mb-3">${erro.message}</p>
                                <button class="btn btn-sm btn-primary" onclick="carregarBackups()">
                                    <i class="fas fa-redo me-1"></i>Tentar novamente
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // MOSTRAR BACKUPS NA TABELA - VERS√ÉO SIMPLIFICADA
        function mostrarBackups(backups) {
            console.log('üìä MostrarBackups chamada com:', backups);
            console.log('Quantidade:', backups.length);
            
            const tbody = document.getElementById('tabelaBackups');
            const loadingRow = document.getElementById('loadingRow');
            const semBackupsDiv = document.getElementById('semBackups');
            
            // Remover loading
            if (loadingRow) loadingRow.remove();
            
            // Verificar se h√° backups
            if (!backups || !Array.isArray(backups) || backups.length === 0) {
                console.log('üì≠ Nenhum backup para mostrar');
                tbody.innerHTML = '';
                semBackupsDiv.classList.remove('d-none');
                document.getElementById('btnExcluirVarios').classList.add('d-none');
                return;
            }
            
            console.log(`‚úÖ Mostrando ${backups.length} backup(s)`);
            
            // Esconder mensagem "sem backups"
            semBackupsDiv.classList.add('d-none');
            
            // Gerar linhas da tabela
            let html = '';
            backups.forEach((backup, index) => {
                console.log(`Backup ${index}:`, backup);
                
                const nomeArquivo = backup.arquivo || backup.nome || `backup_${index + 1}`;
                const tipo = backup.tipo || 'desconhecido';
                const dataCriacao = backup.dataCriacao || backup.data || backup.createdAt || new Date().toISOString();
                const tamanho = backup.tamanho || backup.size ? formatarTamanho(backup.tamanho || backup.size) : 'N/A';
                const descricao = backup.descricao || backup.description || '';
                
                const estaSelecionado = backupsSelecionados.includes(nomeArquivo);
                
                // Cor do badge baseado no tipo
                let badgeCor = 'bg-secondary';
                let tipoDisplay = tipo;
                
                if (tipo === 'database' || tipo.includes('database')) {
                    badgeCor = 'bg-primary';
                    tipoDisplay = 'Banco de Dados';
                } else if (tipo === 'logs' || tipo.includes('log')) {
                    badgeCor = 'bg-warning';
                    tipoDisplay = 'Logs';
                } else if (tipo === 'reports' || tipo.includes('report')) {
                    badgeCor = 'bg-info';
                    tipoDisplay = 'Relat√≥rios';
                }
                
                html += `
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input checkBackup" 
                                value="${nomeArquivo}"
                                data-tipo="${tipo}"
                                ${estaSelecionado ? 'checked' : ''}
                                onchange="toggleSelecao('${nomeArquivo}')">
                        </td>
                        <td>
                            <div class="fw-bold text-truncate" style="max-width: 250px;" 
                                title="${nomeArquivo}">
                                ${nomeArquivo}
                            </div>
                            ${descricao ? `<small class="text-muted d-block mt-1">${descricao}</small>` : ''}
                        </td>
                        <td>
                            <span class="badge ${badgeCor}">${tipoDisplay}</span>
                        </td>
                        <td>
                            <div>${formatarData(dataCriacao)}</div>
                            <small class="text-muted">${tempoRelativo(dataCriacao)}</small>
                        </td>
                        <td><span class="badge bg-secondary">${tamanho}</span></td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary" 
                                        onclick="baixarBackup('${tipo}', '${nomeArquivo}')"
                                        title="Baixar">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-danger" 
                                        onclick="solicitarExclusao('${tipo}', '${nomeArquivo}')"
                                        title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            console.log('‚úÖ Tabela atualizada com sucesso');
        }

        // FUN√á√ÉO AUXILIAR PARA MOSTRAR "SEM BACKUPS"
        function mostrarSemBackups() {
            const tbody = document.getElementById('tabelaBackups');
            const semBackupsDiv = document.getElementById('semBackups');
            
            tbody.innerHTML = '';
            semBackupsDiv.classList.remove('d-none');
            document.getElementById('btnExcluirVarios').classList.add('d-none');
        }

        // SELECIONAR/DESELECIONAR BACKUP
        function toggleSelecao(nome) {
            const index = backupsSelecionados.indexOf(nome);
            if (index === -1) {
                backupsSelecionados.push(nome);
            } else {
                backupsSelecionados.splice(index, 1);
            }
            atualizarBotaoExcluir();
        }

        // SELECIONAR TODOS OS BACKUPS
        function selecionarTodos(selecionar) {
            const checkboxes = document.querySelectorAll('.checkBackup');
            backupsSelecionados = [];
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selecionar;
                if (selecionar) {
                    backupsSelecionados.push(checkbox.value);
                }
            });
            
            atualizarBotaoExcluir();
        }

        // ATUALIZAR BOT√ÉO DE EXCLUIR V√ÅRIOS
        function atualizarBotaoExcluir() {
            const btn = document.getElementById('btnExcluirVarios');
            if (backupsSelecionados.length > 0) {
                btn.classList.remove('d-none');
                btn.innerHTML = `<i class="fas fa-trash me-1"></i>Excluir (${backupsSelecionados.length})`;
            } else {
                btn.classList.add('d-none');
            }
            
            // Atualizar checkbox "Selecionar Todos"
            const checkTodos = document.getElementById('checkTodos');
            const checkboxes = document.querySelectorAll('.checkBackup');
            const total = checkboxes.length;
            const selecionados = document.querySelectorAll('.checkBackup:checked').length;
            
            if (selecionados === 0) {
                checkTodos.checked = false;
                checkTodos.indeterminate = false;
            } else if (selecionados === total) {
                checkTodos.checked = true;
                checkTodos.indeterminate = false;
            } else {
                checkTodos.checked = false;
                checkTodos.indeterminate = true;
            }
        }

        // ============================================
        // FUN√á√ïES DO MODAL (VERS√ÉO SIMPLIFICADA)
        // ============================================

        // EXECUTAR BACKUP MANUAL - VERS√ÉO SIMPLES QUE FUNCIONA
        function executarBackupManual() {
            console.log('üéØ Abrindo modal de backup...');
            
            // Verificar se o modal existe
            const modalElement = document.getElementById('modalNovoBackup');
            if (!modalElement) {
                console.error('‚ùå Modal n√£o encontrado!');
                mostrarNotificacao('Erro: Modal n√£o encontrado', 'danger');
                return;
            }
            
            console.log('‚úÖ Modal encontrado, criando inst√¢ncia...');
            
            // Criar inst√¢ncia do modal Bootstrap
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
            
            // Mostrar o modal
            modal.show();
            
            console.log('‚úÖ Modal mostrado com sucesso');
            
            // Focar no campo ap√≥s o modal ser exibido
            setTimeout(() => {
                const nomeInput = document.getElementById('nomeBackup');
                if (nomeInput) {
                    nomeInput.focus();
                }
            }, 300);
        }

        // INICIAR BACKUP (CONFIRMAR E EXECUTAR)
        async function iniciarBackup() {
            // Obter dados do formul√°rio
            const nome = document.getElementById('nomeBackup').value.trim();
            const descricao = document.getElementById('descricaoBackup').value.trim();
            
            // Fechar modal de configura√ß√£o
            const modalConfigElement = document.getElementById('modalNovoBackup');
            if (modalConfigElement) {
                const modalConfig = bootstrap.Modal.getInstance(modalConfigElement);
                if (modalConfig) modalConfig.hide();
            }
            
            // Limpar formul√°rio
            document.getElementById('nomeBackup').value = '';
            document.getElementById('descricaoBackup').value = '';
            
            // Abrir modal de progresso
            const modalProgressoElement = document.getElementById('modalProgresso');
            if (modalProgressoElement) {
                const modalProgresso = new bootstrap.Modal(modalProgressoElement);
                modalProgresso.show();
            }
            
            // Configurar vari√°vel de controle
            processoBackupAtivo = true;
            
            try {
                // Preparar dados para envio
                const dados = {};
                if (nome) dados.nome = nome;
                if (descricao) dados.descricao = descricao;
                
                // Fazer requisi√ß√£o
                const resposta = await fetch('/api/backup/executar-manual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: Object.keys(dados).length > 0 ? JSON.stringify(dados) : null
                });
                
                if (!resposta.ok) {
                    const erro = await resposta.json();
                    throw new Error(erro.message || 'Erro ao executar backup');
                }
                
                const resultado = await resposta.json();
                
                // Atualizar progresso
                let progresso = 0;
                const intervalo = setInterval(() => {
                    if (!processoBackupAtivo) {
                        clearInterval(intervalo);
                        return;
                    }
                    
                    progresso += 10;
                    const barraProgresso = document.getElementById('barraProgresso');
                    if (barraProgresso) barraProgresso.style.width = progresso + '%';
                    
                    const mensagemProgresso = document.getElementById('mensagemProgresso');
                    if (mensagemProgresso) {
                        if (progresso >= 30) {
                            mensagemProgresso.textContent = 'Exportando banco de dados...';
                        }
                        if (progresso >= 60) {
                            mensagemProgresso.textContent = 'Compactando arquivos...';
                        }
                        if (progresso >= 90) {
                            mensagemProgresso.textContent = 'Finalizando backup...';
                        }
                    }
                    
                    if (progresso >= 100) {
                        clearInterval(intervalo);
                        setTimeout(() => {
                            if (processoBackupAtivo) {
                                const modalProgresso = bootstrap.Modal.getInstance(document.getElementById('modalProgresso'));
                                if (modalProgresso) modalProgresso.hide();
                                mostrarNotificacao('Backup criado com sucesso!', 'success');
                                carregarTudo();
                                processoBackupAtivo = false;
                            }
                        }, 500);
                    }
                }, 500);
                
            } catch (erro) {
                console.error('Erro ao criar backup:', erro);
                const modalProgresso = bootstrap.Modal.getInstance(document.getElementById('modalProgresso'));
                if (modalProgresso) modalProgresso.hide();
                mostrarNotificacao(erro.message || 'Erro ao criar backup', 'danger');
                processoBackupAtivo = false;
            }
        }

        // CANCELAR BACKUP EM ANDAMENTO
        function cancelarBackup() {
            processoBackupAtivo = false;
            const modalProgresso = bootstrap.Modal.getInstance(document.getElementById('modalProgresso'));
            if (modalProgresso) modalProgresso.hide();
            mostrarNotificacao('Backup cancelado pelo usu√°rio', 'warning');
        }

        // SOLICITAR EXCLUS√ÉO DE UM BACKUP
        function solicitarExclusao(tipo, arquivo) {
            backupAtualParaExcluir = { tipo, arquivo };
            document.getElementById('nomeBackupExcluir').textContent = arquivo;
            const modal = new bootstrap.Modal(document.getElementById('modalExcluir'));
            modal.show();
        }

        // CONFIRMAR EXCLUS√ÉO
        async function confirmarExclusao() {
            if (!backupAtualParaExcluir) return;
            
            const { tipo, arquivo } = backupAtualParaExcluir;
            
            try {
                const resposta = await fetch(`/api/backup/excluir/${tipo}/${encodeURIComponent(arquivo)}`, {
                    method: 'DELETE'
                });
                
                const resultado = await resposta.json();
                
                if (resultado.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalExcluir'));
                    if (modal) modal.hide();
                    
                    mostrarNotificacao(resultado.message || 'Backup exclu√≠do com sucesso!', 'success');
                    carregarTudo();
                } else {
                    mostrarNotificacao(resultado.message || 'Erro ao excluir backup', 'danger');
                }
            } catch (erro) {
                console.error('Erro ao excluir backup:', erro);
                mostrarNotificacao('Erro de conex√£o ao excluir backup', 'danger');
            } finally {
                backupAtualParaExcluir = null;
            }
        }

        // EXCLUIR BACKUPS SELECIONADOS - VERS√ÉO ATUALIZADA COM TIPOS
        async function excluirSelecionados() {
            if (backupsSelecionados.length === 0) return;
            
            if (!confirm(`Deseja excluir ${backupsSelecionados.length} backup(s) selecionado(s)?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }
            
            try {
                let sucessos = 0;
                let erros = 0;
                
                // Para cada backup selecionado
                for (const nomeBackup of backupsSelecionados) {
                    try {
                        // Encontrar o checkbox para obter o tipo
                        const checkbox = document.querySelector(`.checkBackup[value="${nomeBackup}"]`);
                        const tipo = checkbox ? checkbox.getAttribute('data-tipo') : 'database';
                        
                        const resposta = await fetch(`/api/backup/excluir/${tipo}/${encodeURIComponent(nomeBackup)}`, {
                            method: 'DELETE'
                        });
                        
                        if (resposta.ok) {
                            sucessos++;
                        } else {
                            erros++;
                        }
                    } catch {
                        erros++;
                    }
                }
                
                // Mostrar resultado
                let mensagem = `${sucessos} backup(s) exclu√≠do(s) com sucesso.`;
                if (erros > 0) {
                    mensagem += ` ${erros} erro(s) ocorreram.`;
                }
                
                mostrarNotificacao(mensagem, sucessos > 0 ? 'success' : 'warning');
                
                // Limpar sele√ß√£o e recarregar
                backupsSelecionados = [];
                atualizarBotaoExcluir();
                carregarTudo();
                
            } catch (erro) {
                console.error('Erro ao excluir backups:', erro);
                mostrarNotificacao('Erro ao excluir backups selecionados', 'danger');
            }
        }

        // BAIXAR BACKUP
        function baixarBackup(tipo, arquivo) {
            // Abrir em nova aba para download
            window.open(`/api/backup/download/${tipo}/${encodeURIComponent(arquivo)}`, '_blank');
        }

        // CARREGAR TUDO (ESTAT√çSTICAS + BACKUPS)
        function carregarTudo() {
            carregarEstatisticas();
            carregarBackups();
        }

        // ATUALIZAR TUDO (BOT√ÉO)
        function atualizarTudo() {
            mostrarNotificacao('Atualizando lista de backups...', 'info');
            carregarTudo();
        }

        // ============================================
        // INICIALIZA√á√ÉO DA P√ÅGINA
        // ============================================

        // INICIALIZA√á√ÉO DA P√ÅGINA
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä P√°gina de Backups inicializada');
            
            // Carregar dados reais da API
            carregarTudo();
            
            // Atualizar estat√≠sticas a cada 30 segundos
            setInterval(carregarEstatisticas, 30000);
            
            // Adicionar evento para atualizar ao focar na p√°gina
            window.addEventListener('focus', function() {
                console.log('üîÑ P√°gina em foco, atualizando dados...');
                carregarEstatisticas();
            });
        });
    </script>
</body>
</html>