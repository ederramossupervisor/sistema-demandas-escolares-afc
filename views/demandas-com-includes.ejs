<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- INCLUI o cabe√ßalho completo -->
    <%- include('partials/head') %>
    <style>
/* Estilos para o modal de detalhes */
#detalhesDescricao {
    line-height: 1.6;
    font-size: 1rem;
}

#detalhesDescricao::-webkit-scrollbar {
    width: 8px;
}

#datalhesDescricao::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

#detalhesDescricao::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

#detalhesDescricao::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Cards dentro do modal */
#modalDetalhesDemanda .card {
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    transition: transform 0.2s;
}

#modalDetalhesDemanda .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Badges */
#modalDetalhesDemanda .badge {
    font-size: 0.9rem;
    padding: 0.5em 0.8em;
}

/* Responsividade */
@media (max-width: 768px) {
    #modalDetalhesDemanda .modal-dialog {
        margin: 0.5rem;
    }
    
    #modalDetalhesDemanda .row {
        flex-direction: column;
    }
}
/* ==================== */
/* RESPONSIVIDADE MOBILE - GERENCIAR DEMANDAS */
/* ==================== */
@media (max-width: 768px) {
    /* CABE√áALHO DA P√ÅGINA */
    .text-gradient {
        font-size: 1.4rem !important;
    }
    
    .lead {
        font-size: 0.9rem !important;
    }
    
    /* FILTROS - MUDAR PARA 1 COLUNA E MAIORES */
    .row.g-3.mb-4 {
        margin-left: -5px !important;
        margin-right: -5px !important;
    }
    
    .row.g-3.mb-4 .col-md-3 {
        width: 100% !important;
        margin-bottom: 15px !important;
    }
    
    .form-label.fw-bold {
        font-size: 1rem !important;
        margin-bottom: 8px !important;
    }
    
    .form-select {
        padding: 16px 15px !important;
        font-size: 16px !important;
        min-height: 52px;
        border-radius: 10px;
    }
    
    /* BOT√ÉO NOVA DEMANDA - MAIOR */
    .btn-primary {
        padding: 14px 20px !important;
        font-size: 16px !important;
        min-height: 50px;
        min-width: 140px; /* Largura m√≠nima para toque */
    }
    
    /* ==================== */
    /* MODAIS - OTIMIZA√á√ÉO PARA MOBILE */
    /* ==================== */
    
    /* MODAL NOVA DEMANDA */
    #novaDemandaModal .modal-dialog,
    #modalEditarDemanda .modal-dialog,
    #modalDetalhesDemanda .modal-dialog {
        margin: 0.5rem !important;
        max-height: 90vh !important;
    }
    
    #novaDemandaModal .modal-content,
    #modalEditarDemanda .modal-content,
    #modalDetalhesDemanda .modal-content {
        max-height: 90vh !important;
        overflow-y: auto !important;
    }
    
    /* CONTE√öDO DOS MODAIS - 1 COLUNA */
    .modal-body .row.g-3 .col-md-6 {
        width: 100% !important;
        margin-bottom: 15px !important;
    }
    
    /* INPUTS NOS MODAIS - MAIORES */
    .modal-body .form-control,
    .modal-body .form-select,
    .modal-body .form-control-lg,
    .modal-body .form-select-lg {
        padding: 16px 15px !important;
        font-size: 16px !important;
        min-height: 52px;
    }
    
    /* TEXTAREA MAIOR */
    .modal-body textarea {
        min-height: 120px !important;
        font-size: 16px !important;
        padding: 15px !important;
    }
    
    /* LABELS NOS MODAIS */
    .modal-body .form-label.fw-bold {
        font-size: 1rem !important;
        margin-bottom: 10px !important;
    }
    
    /* BOT√ïES DOS MODAIS - MAIORES */
    .modal-footer .btn {
        padding: 14px 20px !important;
        font-size: 16px !important;
        min-height: 50px;
        flex: 1; /* Distribui espa√ßo igual */
        margin: 2px !important;
    }
    
    /* BOT√ïES EM LINHA - REORGANIZAR */
    .modal-footer {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    /* TABELA DE DEMANDAS - MAIS LEG√çVEL */
    .table-responsive {
        font-size: 0.9rem;
    }
    
    .table th, .table td {
        padding: 10px 5px;
    }
    
    /* BOT√ïES DE A√á√ÉO NA TABELA - MAIORES */
    .btn-group-sm .btn {
        padding: 8px 12px !important;
        min-width: 40px;
    }
    
    /* REMOVER HOVER EM TOUCH */
    .btn:hover {
        transform: none !important;
    }
    
    /* MODAL DE DETALHES - REORGANIZAR */
    #modalDetalhesDemanda .row .col-md-6 {
        width: 100% !important;
        margin-bottom: 20px !important;
    }
    
    /* CARDS NOS DETALHES */
    #modalDetalhesDemanda .card {
        margin-bottom: 15px !important;
    }
    
    /* BADGES MAIORES */
    .badge {
        font-size: 0.85rem !important;
        padding: 0.6em 1em !important;
    }
}

/* ==================== */
/* CELULARES MUITO PEQUENOS (375px) */
/* ==================== */
@media (max-width: 375px) {
    /* FILTROS COMPACTOS */
    .row.g-3.mb-4 .col-md-3 {
        margin-bottom: 12px !important;
    }
    
    .form-select {
        padding: 14px 12px !important;
        min-height: 48px;
    }
    
    /* MODAIS COMPACTOS */
    #novaDemandaModal .modal-dialog,
    #modalEditarDemanda .modal-dialog {
        margin: 0.2rem !important;
    }
    
    .modal-body {
        padding: 1rem !important;
    }
    
    /* BOT√ïES AINDA MAIS COMPACTOS */
    .modal-footer .btn {
        padding: 12px 15px !important;
        font-size: 15px !important;
        min-height: 46px;
    }
    
    /* HEADER DOS MODAIS */
    .modal-header h5 {
        font-size: 1.1rem !important;
    }
    
    /* TEXTO PEQUENO */
    small.form-text {
        font-size: 0.8rem !important;
    }
}

/* ==================== */
/* PREVEN√á√ÉO DE ZOOM iOS NOS MODAIS */
/* ==================== */
@media screen and (-webkit-min-device-pixel-ratio: 0) {
    .modal-body input[type="text"],
    .modal-body input[type="email"],
    .modal-body input[type="date"],
    .modal-body select,
    .modal-body textarea {
        font-size: 16px !important;
    }
}

/* ==================== */
/* MELHORIAS VISUAIS GERAIS */
/* ==================== */
/* Destaque para campos obrigat√≥rios nos modais */
.modal-body .form-label.fw-bold::after {
    content: " *";
    color: #dc3545;
    font-weight: bold;
}

/* Foco melhor nos inputs dos modais */
.modal-body .form-control:focus,
.modal-body .form-select:focus {
    border-color: #667eea !important;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2) !important;
}

/* Textarea com resize vertical */
.modal-body textarea {
    resize: vertical;
    min-height: 100px;
    max-height: 300px;
}

/* Labels mais espa√ßados */
.modal-body .form-group {
    margin-bottom: 1.5rem !important;
}
</style>
</head>
<body>
    <!-- INCLUI a navbar -->
    <%- include('partials/navbar', {currentPage: 'demandas', user: user}) %>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar Unificada - Vis√≠vel apenas no desktop -->
            <div class="col-md-3 d-none d-md-block">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-3">
                        <%- include('partials/sidebar', { 
                            currentPage: 'demandas', 
                            user: user,
                            escolas: escolas || []
                        }); %>
                    </div>
                </div>
            </div>
            <!-- Conte√∫do Principal -->
            <div class="col-md-9">
                <!-- Cabe√ßalho da P√°gina -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h1 class="text-gradient">
                            <i class="fas fa-tasks me-2"></i> Gerenciar Demandas
                        </h1>
                        <p class="text-muted lead">
                            <i class="fas fa-info-circle me-1"></i>
                            Crie, visualize e gerencie todas as demandas escolares
                        </p>
                    </div>
                </div>

                <!-- Conte√∫do da P√°gina -->
                <div class="card border-0 shadow-lg">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0 text-white"><i class="fas fa-filter me-2"></i> Filtros Avan√ßados</h5>
                                <small class="text-white opacity-75">Filtre as demandas por status, escola ou prioridade</small>
                            </div>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novaDemandaModal">
                                <i class="fas fa-plus-circle me-2"></i> Nova Demanda
                            </button>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <!-- Filtros -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <label class="form-label fw-bold"><i class="fas fa-flag me-1"></i> Status</label>
                                <select class="form-select">
                                    <option value="">Todas as Demandas</option>
                                    <option value="pendente">‚è≥ Pendentes</option>
                                    <option value="em_andamento">üîÑ Em Andamento</option>
                                    <option value="concluida">‚úÖ Conclu√≠das</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold"><i class="fas fa-school me-1"></i> Escola</label>
                                <select class="form-select">
                                    <option value="">Todas as Escolas</option>
                                    <% escolas.forEach(function(escola) { %>
                                        <option value="<%= escola %>"><%= escola.substring(0, 30) %>...</option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold"><i class="fas fa-exclamation-triangle me-1"></i> Prioridade</label>
                                <select class="form-select">
                                    <option value="">Todas as Prioridades</option>
                                    <option value="Baixa">üìó Baixa</option>
                                    <option value="Media">üìò M√©dia</option>
                                    <option value="Alta">üìô Alta</option>
                                    <option value="Urgente">üìï Urgente</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold"><i class="fas fa-building me-1"></i> Departamento</label>
                                <select class="form-select">
                                    <option value="">üåê Todos os Departamentos</option>
                                    <option value="Gest√£o">üè´ Gest√£o</option>
                                    <option value="Pedagogico">üéì Pedag√≥gico</option>
                                    <option value="Secretaria">üìÅ Secretaria</option>
                                    <option value="Supervisao">üîç Supervis√£o</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold"><i class="fas fa-user me-1"></i> Minhas Demandas</label>
                            <select class="form-select" id="filtroMinhas">
                                <option value="">Todas as Demandas</option>
                                <option value="criadas">üìù Criadas por Mim</option>
                                <option value="atribuidas">üéØ Atribu√≠das a Mim</option>
                            </select>
                        </div>

                        <!-- Tabela de Demandas -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>T√≠tulo</th>
                                        <th>Escola</th>
                                        <th>Departamento</th>
                                        <th>Prioridade</th>
                                        <th>Status</th>
                                        <th>Prazo</th>
                                        <th class="text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaDemandas">
                                    <tr>
                                        <td colspan="7" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            <p class="mt-3 text-muted">Carregando demandas...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Nova Demanda -->
    <div class="modal fade" id="novaDemandaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow" style="max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-plus-circle me-2"></i> Criar Nova Demanda
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formNovaDemanda">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-heading me-1"></i> T√≠tulo *
                                </label>
                                <input type="text" class="form-control form-control-lg" name="titulo" required 
                                       placeholder="Ex: Reparo urgente na quadra esportiva">
                                <small class="form-text text-muted">Descreva brevemente a demanda</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-school me-1"></i> Escola *
                                </label>
                                <select class="form-select form-select-lg" name="escola" required>
                                    <option value="" selected disabled>Selecione uma escola</option>
                                    <% escolas.forEach(function(escola) { %>
                                        <option value="<%= escola %>"><%= escola %></option>
                                    <% }); %>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-building me-1"></i> Departamento *
                                </label>
                                <select class="form-select form-select-lg" name="departamento" required>
                                    <option value="" selected disabled>Selecione um departamento</option>
                                    <option value="Gest√£o">üè´ Gest√£o</option>
                                    <option value="Pedagogico">üéì Pedag√≥gico</option>
                                    <option value="Secretaria">üìÅ Secretaria</option>
                                    <option value="Supervisao">üîç Supervis√£o</option>
                                    
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-exclamation-triangle me-1"></i> Prioridade
                                </label>
                                <select class="form-select form-select-lg" name="prioridade">
                                    <option value="M√©dia" selected>üìò M√©dia (Padr√£o)</option>
                                    <option value="Baixa">üìó Baixa</option>
                                    <option value="Alta">üìô Alta</option>
                                    <option value="Urgente">üìï Urgente</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar-alt me-1"></i> Prazo *
                                </label>
                                <input type="date" class="form-control form-control-lg" name="prazo" required 
                                       min="<%= new Date().toISOString().split('T')[0] %>">
                                <small class="form-text text-muted">Data limite para conclus√£o</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-user me-1"></i> Solicitante
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       value="<%= user.nome %>" readonly>
                                <small class="form-text text-muted">Voc√™ est√° criando esta demanda</small>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-align-left me-1"></i> Descri√ß√£o Detalhada *
                                </label>
                                <textarea class="form-control" name="descricao" rows="5" required 
                                          placeholder="Descreva detalhadamente a demanda..."></textarea>
                                <small class="form-text text-muted">Quanto mais detalhes, melhor para o atendimento</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="criarDemanda()">
                        <i class="fas fa-save me-1"></i> Criar Demanda
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Editar Demanda -->
    <div class="modal fade" id="modalEditarDemanda" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-edit me-2"></i> Editar Demanda
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formEditarDemanda">
                        <!-- Campo oculto para ID -->
                        <input type="hidden" id="editarDemandaId" name="id">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-heading me-1"></i> T√≠tulo *
                                </label>
                                <input type="text" class="form-control form-control-lg" id="editarTitulo" name="titulo" required 
                                    placeholder="T√≠tulo da demanda">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-school me-1"></i> Escola *
                                </label>
                                <select class="form-select form-select-lg" id="editarEscola" name="escola" required>
                                    <option value="" selected disabled>Selecione uma escola</option>
                                    <% escolas.forEach(function(escola) { %>
                                        <option value="<%= escola %>"><%= escola %></option>
                                    <% }); %>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-building me-1"></i> Departamento *
                                </label>
                                <select class="form-select form-select-lg" id="editarDepartamento" name="departamento" required>
                                    <option value="" selected disabled>Selecione um departamento</option>
                                    <option value="">üåê Todos os Departamentos</option>
                                    <option value="Gest√£o">üè´ Gest√£o</option>
                                    <option value="Pedagogico">üéì Pedag√≥gico</option>
                                    <option value="Secretaria">üìÅ Secretaria</option>
                                    <option value="Supervisao">üîç Supervis√£o</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-exclamation-triangle me-1"></i> Prioridade
                                </label>
                                <select class="form-select form-select-lg" id="editarPrioridade" name="prioridade">
                                    <option value="M√©dia">üìò M√©dia</option>
                                    <option value="Baixa">üìó Baixa</option>
                                    <option value="Alta">üìô Alta</option>
                                    <option value="Urgente">üìï Urgente</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-flag me-1"></i> Status
                                </label>
                                <select class="form-select form-select-lg" id="editarStatus" name="status">
                                    <option value="pendente">‚è≥ Pendente</option>
                                    <option value="em_andamento">üîÑ Em Andamento</option>
                                    <option value="concluida">‚úÖ Conclu√≠da</option>
                                    <option value="cancelada">‚ùå Cancelada</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar-alt me-1"></i> Prazo *
                                </label>
                                <input type="date" class="form-control form-control-lg" id="editarPrazo" name="prazo" required>
                                <small class="form-text text-muted">Data limite para conclus√£o</small>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-align-left me-1"></i> Descri√ß√£o Detalhada *
                                </label>
                                <textarea class="form-control" id="editarDescricao" name="descricao" rows="4" required 
                                        placeholder="Descreva detalhadamente a demanda..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-warning btn-lg" onclick="salvarEdicaoDemanda()">
                        <i class="fas fa-save me-1"></i> Salvar Altera√ß√µes
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Ver Detalhes da Demanda -->
    <div class="modal fade" id="modalDetalhesDemanda" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-info-circle me-2"></i> Detalhes da Demanda
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h3 id="detalhesTitulo" class="mb-2 text-primary"></h3>
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <span id="detalhesStatus" class="badge"></span>
                                <span id="detalhesPrioridade" class="badge"></span>
                                <span id="detalhesDepartamento" class="badge bg-light text-dark"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-school me-1"></i> Informa√ß√µes da Escola</h6>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1"><strong>Escola:</strong></p>
                                    <p id="detalhesEscola" class="mb-3"></p>
                                    
                                    <p class="mb-1"><strong>Criado por:</strong></p>
                                    <p id="detalhesCriadoPor" class="mb-3"></p>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-calendar me-1"></i> Datas</h6>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1"><strong>Criado em:</strong></p>
                                    <p id="detalhesCriadoEm" class="mb-3"></p>
                                    
                                    <p class="mb-1"><strong>Prazo para conclus√£o:</strong></p>
                                    <p id="detalhesPrazo" class="mb-0"></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-align-left me-1"></i> Descri√ß√£o Completa</h6>
                                </div>
                                <div class="card-body">
                                    <div id="detalhesDescricao" style="max-height: 200px; overflow-y: auto;">
                                        <!-- A descri√ß√£o ser√° inserida aqui -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-history me-1"></i> Hist√≥rico</h6>
                                </div>
                                <div class="card-body">
                                    <div id="detalhesHistorico">
                                        <p class="text-muted mb-0">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Hist√≥rico de altera√ß√µes ser√° implementado em breve
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-id-card me-2"></i>
                        <strong>ID da Demanda:</strong> <code id="detalhesId"></code>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Fechar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="editarDemanda(document.getElementById('detalhesId').innerText)">
                        <i class="fas fa-edit me-1"></i> Editar esta Demanda
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- INCLUI o rodap√© -->
    <%- include('partials/footer', {
        user: user,
        totalDemandas: totalDemandas
    }) %>

    <!-- INCLUI o bot√£o PWA -->
    <%- include('partials/pwa-button') %>

    <!-- INCLUI os scripts -->
    <%- include('partials/scripts') %>

    <!-- Scripts espec√≠ficos da p√°gina -->
<!-- Scripts espec√≠ficos da p√°gina -->
<script>
// Vari√°veis globais
let todasDemandas = [];

// Fun√ß√£o para formatar data
function formatarData(dataString) {
    if (!dataString) return 'N/A';
    try {
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR');
    } catch {
        return 'Data inv√°lida';
    }
}

// Fun√ß√£o para obter badge de prioridade
function getBadgePrioridade(prioridade) {
    const badges = {
        'Baixa': 'badge bg-success',
        'M√©dia': 'badge bg-primary', 
        'Alta': 'badge bg-warning',
        'Urgente': 'badge bg-danger'
    };
    return badges[prioridade] || 'badge bg-secondary';
}

// Fun√ß√£o para obter badge de status (retorna HTML)
function getBadgeStatusHTML(status) {
    const badges = {
        'pendente': 'badge bg-warning',
        'em_andamento': 'badge bg-info',
        'concluida': 'badge bg-success',
        'cancelada': 'badge bg-secondary'
    };
    const textos = {
        'pendente': 'Pendente',
        'em_andamento': 'Em Andamento',
        'concluida': 'Conclu√≠da',
        'cancelada': 'Cancelada'
    };
    return `<span class="${badges[status] || 'badge bg-secondary'}">${textos[status] || status}</span>`;
}

// Fun√ß√£o para obter apenas a classe CSS do badge (para uso no modal)
function getBadgeStatus(status) {
    const badges = {
        'pendente': 'badge bg-warning',
        'em_andamento': 'badge bg-info',
        'concluida': 'badge bg-success',
        'cancelada': 'badge bg-secondary'
    };
    return badges[status] || 'badge bg-secondary';
}

// Fun√ß√£o para criar demanda (conectada com a API)
async function criarDemanda() {
    const form = document.getElementById('formNovaDemanda');
    const botao = document.querySelector('#novaDemandaModal .btn-primary');
    
    if (!form || !botao) {
        alert('Erro: Formul√°rio n√£o encontrado');
        return;
    }
    
    // Validar formul√°rio
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Coletar dados do formul√°rio
    const formData = new FormData(form);
    const dados = Object.fromEntries(formData.entries());
    
    // Salvar texto original do bot√£o
    const textoOriginal = botao.innerHTML;
    
    // Mostrar loading
    botao.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Criando...';
    botao.disabled = true; // ‚úÖ CORRIGIDO: estava "botando"
    
    try {
        console.log('üì§ Enviando demanda:', dados);
        
        // Enviar para API
        const response = await fetch('/api/demandas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            // Sucesso!
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: '‚úÖ Demanda Criada!',
                    text: 'A demanda foi criada com sucesso e j√° est√° dispon√≠vel no sistema.',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                });
            } else {
                alert('‚úÖ Demanda criada com sucesso!');
            }
            
            // Fechar modal
            const modalElement = document.getElementById('novaDemandaModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
            // Limpar formul√°rio
            form.reset();
            
            // Atualizar lista de demandas
            await carregarDemandas();
            
        } else {
            // Erro
            let mensagemErro = resultado.message || 'Erro ao criar demanda';
            
            if (resultado.campos_faltando) {
                mensagemErro += '\n\nCampos faltando:';
                Object.keys(resultado.campos_faltando).forEach(campo => {
                    if (resultado.campos_faltando[campo]) {
                        mensagemErro += `\n‚Ä¢ ${campo.charAt(0).toUpperCase() + campo.slice(1)}`;
                    }
                });
            }
            
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: '‚ùå Erro ao Criar',
                    html: mensagemErro.replace(/\n/g, '<br>'),
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Corrigir'
                });
            } else {
                alert('‚ùå Erro: ' + mensagemErro);
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Erro de Conex√£o',
                text: 'N√£o foi poss√≠vel conectar ao servidor. Verifique sua conex√£o e tente novamente.',
                confirmButtonColor: '#d33',
                confirmButtonText: 'OK'
            });
        } else {
            alert('‚ùå Erro de conex√£o com o servidor');
        }
    } finally {
        // Restaurar bot√£o
        botao.innerHTML = textoOriginal;
        botao.disabled = false;
    }
}

// Fun√ß√£o para carregar todas as demandas
async function carregarDemandas() {
    const tabela = document.getElementById('tabelaDemandas');
    
    if (!tabela) {
        console.error('Tabela n√£o encontrada');
        return;
    }
    
    // Mostrar loading
    tabela.innerHTML = `
        <tr>
            <td colspan="7" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3 text-muted">Carregando demandas...</p>
            </td>
        </tr>
    `;
    
    try {
        // Buscar demandas da API
        const response = await fetch('/api/demandas');
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        if (resultado.success && resultado.data) {
            todasDemandas = resultado.data;
            renderizarTabela(todasDemandas);
            console.log(`‚úÖ ${todasDemandas.length} demandas carregadas`);
        } else {
            throw new Error('Formato de resposta inv√°lido');
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar demandas:', error);
        tabela.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Erro ao carregar demandas</strong>
                        <p class="mb-0 mt-2">${error.message}</p>
                        <button class="btn btn-sm btn-primary mt-3" onclick="carregarDemandas()">
                            <i class="fas fa-redo me-1"></i> Tentar Novamente
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
}

// Fun√ß√£o para renderizar a tabela
function renderizarTabela(demandas) {
    const tabela = document.getElementById('tabelaDemandas');
    
    if (!tabela) return;
    
    if (!demandas || demandas.length === 0) {
        tabela.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Nenhuma demanda encontrada</strong>
                        <p class="mb-0 mt-2">Clique em "Nova Demanda" para criar a primeira demanda do sistema.</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    // Ordenar por data mais recente
    demandas.sort((a, b) => new Date(b.criadoEm || 0) - new Date(a.criadoEm || 0));
    
    // Criar linhas da tabela
    let html = '';
    
    demandas.forEach((demanda, index) => {
        const descricao = demanda.descricao || '';
        const escola = demanda.escola || '';
        const departamento = demanda.departamento || '';
        const prioridade = demanda.prioridade || 'M√©dia';
        const status = demanda.status || 'pendente';
        
        html += `
            <tr>
                <td>
                    <strong>${demanda.titulo || 'Sem t√≠tulo'}</strong>
                    <br>
                    <small class="text-muted">${descricao.substring(0, 50)}${descricao.length > 50 ? '...' : ''}</small>
                </td>
                <td>
                    <i class="fas fa-school me-1"></i>
                    <small>${escola.substring(0, 20)}${escola.length > 20 ? '...' : ''}</small>
                </td>
                <td>
                    <span class="badge bg-light text-dark">
                        ${departamento}
                    </span>
                </td>
                <td>
                    <span class="${getBadgePrioridade(prioridade)}">
                        ${prioridade}
                    </span>
                </td>
                <td>
                    ${getBadgeStatusHTML(status)}
                </td>
                <td>
                    <small>${formatarData(demanda.prazo)}</small>
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" title="Ver Detalhes" onclick="verDetalhes('${demanda._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning" title="Editar" onclick="editarDemanda('${demanda._id}')">
                            <i class="fas fa-edit"></i>
                        <button class="btn btn-outline-danger" title="Excluir" onclick="excluirDemandaComNotificacao('${demanda._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tabela.innerHTML = html;
}

// Fun√ß√£o para filtrar demandas
function filtrarDemandas() {
    try {
        // ‚úÖ CORRIGIDO: Seletores mais espec√≠ficos
        const selects = document.querySelectorAll('.card-body .form-select');
        if (selects.length < 4) {
            console.warn('Filtros n√£o encontrados');
            return;
        }
        
        const status = selects[0].value;
        const escola = selects[1].value;
        const prioridade = selects[2].value;
        const departamento = selects[3].value;
        
        let filtradas = todasDemandas;
        
        if (status) {
            filtradas = filtradas.filter(d => d.status === status);
        }
        
        if (escola) {
            filtradas = filtradas.filter(d => d.escola === escola);
        }
        
        if (prioridade) {
            filtradas = filtradas.filter(d => d.prioridade === prioridade);
        }
        
        if (departamento) {
            filtradas = filtradas.filter(d => d.departamento === departamento);
        }
        
        renderizarTabela(filtradas);
    } catch (error) {
        console.error('Erro ao filtrar:', error);
    }
}

// Fun√ß√£o para ver detalhes
// Fun√ß√£o para ver detalhes da demanda
async function verDetalhes(id) {
    try {
        console.log('üîç Buscando detalhes da demanda:', id);
        
        // Mostrar loading
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'Carregando...',
                text: 'Buscando informa√ß√µes detalhadas',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }
        
        // Buscar dados da demanda
        const response = await fetch(`/api/demandas/${id}`);
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        if (!resultado.success) {
            throw new Error(resultado.message || 'Erro ao buscar detalhes');
        }
        
        // Fechar loading
        if (typeof Swal !== 'undefined') {
            Swal.close();
        }
        
        const demanda = resultado.data;
        console.log('‚úÖ Detalhes carregados:', demanda);
        
        // Preencher os campos do modal de detalhes
        
        // 1. T√≠tulo
        document.getElementById('detalhesTitulo').textContent = demanda.titulo || 'Sem t√≠tulo';
        
        // 2. Status com badge colorido
        const statusElement = document.getElementById('detalhesStatus');
        statusElement.className = getBadgeStatus(demanda.status || 'pendente');
        statusElement.textContent = {
            'pendente': '‚è≥ Pendente',
            'em_andamento': 'üîÑ Em Andamento',
            'concluida': '‚úÖ Conclu√≠da',
            'cancelada': '‚ùå Cancelada'
        }[demanda.status] || demanda.status;
        
        // 3. Prioridade com badge colorido
        const prioridadeElement = document.getElementById('detalhesPrioridade');
        prioridadeElement.className = getBadgePrioridade(demanda.prioridade || 'M√©dia');
        prioridadeElement.textContent = demanda.prioridade || 'M√©dia';
        
        // 4. Departamento
        document.getElementById('detalhesDepartamento').textContent = demanda.departamento || 'N√£o informado';
        
        // 5. Escola
        document.getElementById('detalhesEscola').textContent = demanda.escola || 'N√£o informada';
        
        // 6. Criado por
        document.getElementById('detalhesCriadoPor').textContent = demanda.criadoPor || 'Sistema';
        
        // 7. Data de cria√ß√£o
        if (demanda.criadoEm) {
            const dataCriacao = new Date(demanda.criadoEm);
            document.getElementById('detalhesCriadoEm').textContent = 
                dataCriacao.toLocaleDateString('pt-BR') + ' ' + 
                dataCriacao.toLocaleTimeString('pt-BR');
        } else {
            document.getElementById('detalhesCriadoEm').textContent = 'N√£o registrada';
        }
        
        // 8. Prazo
        if (demanda.prazo) {
            const dataPrazo = new Date(demanda.prazo);
            const hoje = new Date();
            const diasRestantes = Math.ceil((dataPrazo - hoje) / (1000 * 60 * 60 * 24));
            
            let prazoTexto = dataPrazo.toLocaleDateString('pt-BR');
            
            if (diasRestantes < 0) {
                prazoTexto += ` <span class="badge bg-danger ms-2">Atrasado ${Math.abs(diasRestantes)} dias</span>`;
            } else if (diasRestantes === 0) {
                prazoTexto += ` <span class="badge bg-warning ms-2">Vence hoje</span>`;
            } else if (diasRestantes <= 3) {
                prazoTexto += ` <span class="badge bg-warning ms-2">Vence em ${diasRestantes} dias</span>`;
            } else if (diasRestantes <= 7) {
                prazoTexto += ` <span class="badge bg-info ms-2">Vence em ${diasRestantes} dias</span>`;
            } else {
                prazoTexto += ` <span class="badge bg-success ms-2">Vence em ${diasRestantes} dias</span>`;
            }
            
            document.getElementById('detalhesPrazo').innerHTML = prazoTexto;
        } else {
            document.getElementById('detalhesPrazo').textContent = 'N√£o definido';
        }
        
        // 9. Descri√ß√£o
        const descricaoElement = document.getElementById('detalhesDescricao');
        if (demanda.descricao) {
            // Substituir quebras de linha por <br> para manter formata√ß√£o
            const descricaoFormatada = (demanda.descricao || '')
                .replace(/\n/g, '<br>')
                .replace(/  /g, ' &nbsp;');
            descricaoElement.innerHTML = descricaoFormatada;
        } else {
            descricaoElement.innerHTML = '<p class="text-muted fst-italic">Sem descri√ß√£o detalhada</p>';
        }
        
        // 10. ID
        document.getElementById('detalhesId').textContent = demanda._id;
        
        // Mostrar o modal
        const modal = new bootstrap.Modal(document.getElementById('modalDetalhesDemanda'));
        modal.show();
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar detalhes:', error);
        
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: '‚ùå Erro!',
                text: 'N√£o foi poss√≠vel carregar os detalhes da demanda: ' + error.message,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        } else {
            alert('Erro: ' + error.message);
        }
    }
}

// Fun√ß√£o para editar demanda
async function editarDemanda(id) {
    try {
        console.log('üìù Carregando demanda para edi√ß√£o:', id);
        
        // Mostrar loading
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: 'Carregando...',
                text: 'Buscando dados da demanda',
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }
        
        // Buscar dados da demanda
        const response = await fetch(`/api/demandas/${id}`);
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        if (!resultado.success) {
            throw new Error(resultado.message || 'Erro ao buscar demanda');
        }
        
        // Fechar loading
        if (typeof Swal !== 'undefined') {
            Swal.close();
        }
        
        const demanda = resultado.data;
        console.log('‚úÖ Dados carregados:', demanda);
        
        // Preencher o formul√°rio de edi√ß√£o
        document.getElementById('editarDemandaId').value = demanda._id;
        document.getElementById('editarTitulo').value = demanda.titulo || '';
        document.getElementById('editarDescricao').value = demanda.descricao || '';
        document.getElementById('editarEscola').value = demanda.escola || '';
        document.getElementById('editarDepartamento').value = demanda.departamento || '';
        document.getElementById('editarPrioridade').value = demanda.prioridade || 'M√©dia';
        document.getElementById('editarStatus').value = demanda.status || 'pendente';
        
        // Formatar data para o input date
        if (demanda.prazo) {
            const dataPrazo = new Date(demanda.prazo);
            document.getElementById('editarPrazo').value = dataPrazo.toISOString().split('T')[0];
        }
        
        // Mostrar o modal
        const modal = new bootstrap.Modal(document.getElementById('modalEditarDemanda'));
        modal.show();
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar demanda para edi√ß√£o:', error);
        
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: '‚ùå Erro!',
                text: 'N√£o foi poss√≠vel carregar os dados da demanda: ' + error.message,
                icon: 'error',
                confirmButtonText: 'OK'
            });
        } else {
            alert('Erro: ' + error.message);
        }
    }
}

// Fun√ß√£o para excluir demanda
// Fun√ß√£o para excluir demanda
async function excluirDemanda(id) {
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: '‚ö†Ô∏è Excluir Demanda?',
            html: `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="mb-2"><strong>Esta a√ß√£o n√£o pode ser desfeita!</strong></p>
                    <p class="text-muted">A demanda ser√° removida permanentemente do sistema.</p>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '<i class="fas fa-trash me-1"></i> Sim, excluir!',
            cancelButtonText: '<i class="fas fa-times me-1"></i> Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    // Mostrar loading
                    Swal.fire({
                        title: 'Excluindo...',
                        text: 'Removendo demanda do sistema',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Chamar API DELETE
                    const response = await fetch(`/api/demandas/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const resultado = await response.json();
                    
                    if (resultado.success) {
                        // Atualizar lista local
                        todasDemandas = todasDemandas.filter(d => d._id !== id);
                        renderizarTabela(todasDemandas);
                        
                        Swal.fire({
                            icon: 'success',
                            title: '‚úÖ Exclu√≠da!',
                            text: 'A demanda foi exclu√≠da com sucesso.',
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'OK'
                        });
                    } else {
                        throw new Error(resultado.message || 'Erro ao excluir demanda');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao excluir demanda:', error);
                    
                    Swal.fire({
                        icon: 'error',
                        title: '‚ùå Erro!',
                        text: 'N√£o foi poss√≠vel excluir a demanda: ' + error.message,
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'OK'
                    });
                }
            }
        });
    } else {
        if (confirm('Excluir esta demanda permanentemente?')) {
            try {
                // Chamar API DELETE
                const response = await fetch(`/api/demandas/${id}`, {
                    method: 'DELETE'
                });
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    todasDemandas = todasDemandas.filter(d => d._id !== id);
                    renderizarTabela(todasDemandas);
                    alert('‚úÖ Demanda exclu√≠da com sucesso!');
                } else {
                    alert('‚ùå Erro: ' + resultado.message);
                }
                
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao excluir demanda');
            }
        }
    }
}
// Fun√ß√£o para salvar as altera√ß√µes da demanda
async function salvarEdicaoDemanda() {
    const form = document.getElementById('formEditarDemanda');
    const botao = document.querySelector('#modalEditarDemanda .btn-warning');
    const id = document.getElementById('editarDemandaId').value;
    
    if (!form || !botao || !id) {
        alert('Erro: Dados incompletos para edi√ß√£o');
        return;
    }
    
    // Validar formul√°rio
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Coletar dados do formul√°rio
    const formData = new FormData(form);
    const dados = Object.fromEntries(formData.entries());
    
    // Remover o campo 'id' dos dados (n√£o vai no body do PUT)
    const idDemanda = dados.id;
    delete dados.id;
    
    // Salvar texto original do bot√£o
    const textoOriginal = botao.innerHTML;
    
    // Mostrar loading
    botao.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Salvando...';
    botao.disabled = true;
    
    try {
        console.log('üì§ Enviando atualiza√ß√£o:', idDemanda, dados);
        
        // Enviar para API (PUT)
        const response = await fetch(`/api/demandas/${idDemanda}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            // Sucesso!
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: '‚úÖ Demanda Atualizada!',
                    text: 'As altera√ß√µes foram salvas com sucesso.',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK'
                }).then(() => {
                    // Fechar modal
                    const modalElement = document.getElementById('modalEditarDemanda');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Atualizar lista de demandas
                    carregarDemandas();
                });
            } else {
                alert('‚úÖ Demanda atualizada com sucesso!');
                
                // Fechar modal
                const modalElement = document.getElementById('modalEditarDemanda');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                
                // Atualizar lista de demandas
                carregarDemandas();
            }
            
        } else {
            // Erro
            let mensagemErro = resultado.message || 'Erro ao atualizar demanda';
            
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: '‚ùå Erro ao Salvar',
                    html: mensagemErro.replace(/\n/g, '<br>'),
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Corrigir'
                });
            } else {
                alert('‚ùå Erro: ' + mensagemErro);
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Erro de Conex√£o',
                text: 'N√£o foi poss√≠vel conectar ao servidor. Verifique sua conex√£o e tente novamente.',
                confirmButtonColor: '#d33',
                confirmButtonText: 'OK'
            });
        } else {
            alert('‚ùå Erro de conex√£o com o servidor');
        }
    } finally {
        // Restaurar bot√£o
        botao.innerHTML = textoOriginal;
        botao.disabled = false;
    }
}
// Adicionar eventos aos filtros
function configurarFiltros() {
    try {
        const selects = document.querySelectorAll('.card-body .form-select');
        selects.forEach(select => {
            select.addEventListener('change', filtrarDemandas);
        });
        console.log(`‚úÖ ${selects.length} filtros configurados`);
    } catch (error) {
        console.error('Erro ao configurar filtros:', error);
    }
}

// Adicionar valida√ß√£o de data no formul√°rio
function configurarValidacaoData() {
    const inputData = document.querySelector('input[name="prazo"]');
    if (inputData) {
        // Definir data m√≠nima como amanh√£
        const amanha = new Date();
        amanha.setDate(amanha.getDate() + 1);
        inputData.min = amanha.toISOString().split('T')[0];
        console.log('‚úÖ Valida√ß√£o de data configurada');
    }
}

// Adicionar evento ao bot√£o "Limpar Filtros"
function adicionarBotaoLimparFiltros() {
    const filtrosContainer = document.querySelector('.row.g-3.mb-4');
    if (!filtrosContainer) return;
    
    const botaoLimpar = document.createElement('button');
    botaoLimpar.className = 'btn btn-outline-secondary btn-sm';
    botaoLimpar.innerHTML = '<i class="fas fa-filter-circle-xmark me-1"></i> Limpar Filtros';
    botaoLimpar.onclick = function() {
        const selects = document.querySelectorAll('.card-body .form-select');
        selects.forEach(select => {
            select.value = '';
        });
        renderizarTabela(todasDemandas);
    };
    
    filtrosContainer.parentNode.insertBefore(botaoLimpar, filtrosContainer.nextSibling);
}

// Inicializar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', async function() {
    console.log('‚úÖ P√°gina de demandas inicializada');
    
    // Configurar componentes
    configurarFiltros();
    configurarValidacaoData();
    adicionarBotaoLimparFiltros();
    
    // Carregar demandas
    await carregarDemandas();
    
    // Configurar eventos do modal
    const modal = document.getElementById('novaDemandaModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            const form = document.getElementById('formNovaDemanda');
            if (form) form.reset();
        });
    }
});

// Permitir submit do formul√°rio com Enter
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const modal = document.getElementById('novaDemandaModal');
        if (modal && modal.classList.contains('show')) {
            const activeElement = document.activeElement;
            if (activeElement && activeElement.tagName === 'INPUT') {
                e.preventDefault();
                criarDemanda();
            }
        }
    }
});
/* ============================================
   üîî SISTEMA DE NOTIFICA√á√ïES - INTEGRA√á√ÉO
   ============================================ */

// 1Ô∏è‚É£ NOTIFICA√á√ÉO AO CARREGAR A P√ÅGINA
document.addEventListener('DOMContentLoaded', function() {
    // Aguardar 500ms para a p√°gina carregar completamente
    setTimeout(() => {
        if (typeof showInfo === 'function') {
            showInfo('Sistema de Demandas', 'Carregando todas as demandas...', 2000);
        }
    }, 500);
});

// 2Ô∏è‚É£ NOTIFICA√á√ÉO AO EXCLUIR COM SUCESSO
async function excluirDemandaComNotificacao(id) {
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: '‚ö†Ô∏è Excluir Demanda?',
            html: `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="mb-2"><strong>Esta a√ß√£o n√£o pode ser desfeita!</strong></p>
                    <p class="text-muted">A demanda ser√° removida permanentemente do sistema.</p>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '<i class="fas fa-trash me-1"></i> Sim, excluir!',
            cancelButtonText: '<i class="fas fa-times me-1"></i> Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    // Mostrar loading
                    Swal.fire({
                        title: 'Excluindo...',
                        text: 'Removendo demanda do sistema',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    // Chamar API DELETE
                    const response = await fetch(`/api/demandas/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const resultado = await response.json();
                    
                    if (resultado.success) {
                        // Atualizar lista local
                        todasDemandas = todasDemandas.filter(d => d._id !== id);
                        renderizarTabela(todasDemandas);
                        
                        // Fechar SweetAlert
                        Swal.close();
                        
                        // MOSTRAR NOTIFICA√á√ÉO PERSONALIZADA
                        if (typeof showSuccess === 'function') {
                            showSuccess('‚úÖ Exclu√≠da!', 'A demanda foi removida com sucesso.', 3000);
                        } else {
                            // Fallback se as notifica√ß√µes n√£o carregarem
                            Swal.fire({
                                icon: 'success',
                                title: '‚úÖ Exclu√≠da!',
                                text: 'A demanda foi exclu√≠da com sucesso.',
                                confirmButtonColor: '#3085d6',
                                confirmButtonText: 'OK',
                                timer: 3000,
                                timerProgressBar: true
                            });
                        }
                    } else {
                        throw new Error(resultado.message || 'Erro ao excluir demanda');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao excluir demanda:', error);
                    
                    // Fechar loading
                    Swal.close();
                    
                    // MOSTRAR NOTIFICA√á√ÉO DE ERRO
                    if (typeof showError === 'function') {
                        showError('‚ùå Erro!', 'N√£o foi poss√≠vel excluir a demanda: ' + error.message, 5000);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: '‚ùå Erro!',
                            text: 'N√£o foi poss√≠vel excluir a demanda: ' + error.message,
                            confirmButtonColor: '#d33',
                            confirmButtonText: 'OK'
                        });
                    }
                }
            }
        });
    } else {
        // Fallback sem SweetAlert
        if (confirm('Excluir esta demanda permanentemente?')) {
            try {
                // Chamar API DELETE
                const response = await fetch(`/api/demandas/${id}`, {
                    method: 'DELETE'
                });
                
                const resultado = await response.json();
                
                if (resultado.success) {
                    todasDemandas = todasDemandas.filter(d => d._id !== id);
                    renderizarTabela(todasDemandas);
                    
                    // MOSTRAR NOTIFICA√á√ÉO
                    if (typeof showSuccess === 'function') {
                        showSuccess('‚úÖ Exclu√≠da!', 'Demanda removida com sucesso!', 3000);
                    } else {
                        alert('‚úÖ Demanda exclu√≠da com sucesso!');
                    }
                } else {
                    // MOSTRAR NOTIFICA√á√ÉO DE ERRO
                    if (typeof showError === 'function') {
                        showError('‚ùå Erro!', resultado.message, 5000);
                    } else {
                        alert('‚ùå Erro: ' + resultado.message);
                    }
                }
                
            } catch (error) {
                console.error('Erro:', error);
                if (typeof showError === 'function') {
                    showError('‚ùå Erro!', 'Erro ao excluir demanda', 5000);
                } else {
                    alert('‚ùå Erro ao excluir demanda');
                }
            }
        }
    }
}

// 3Ô∏è‚É£ NOTIFICA√á√ÉO AO CRIAR DEMANDA COM SUCESSO
async function criarDemandaComNotificacao() {
    const form = document.getElementById('formNovaDemanda');
    const botao = document.querySelector('#novaDemandaModal .btn-primary');
    
    if (!form || !botao) {
        if (typeof showError === 'function') {
            showError('‚ùå Erro!', 'Formul√°rio n√£o encontrado', 3000);
        }
        return;
    }
    
    // Validar formul√°rio
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Coletar dados do formul√°rio
    const formData = new FormData(form);
    const dados = Object.fromEntries(formData.entries());
    
    // Salvar texto original do bot√£o
    const textoOriginal = botao.innerHTML;
    
    // Mostrar loading
    botao.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Criando...';
    botao.disabled = true;
    
    try {
        console.log('üì§ Enviando demanda:', dados);
        
        // Enviar para API
        const response = await fetch('/api/demandas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            // Sucesso!
            
            // Fechar modal
            const modalElement = document.getElementById('novaDemandaModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
            // Limpar formul√°rio
            form.reset();
            
            // Atualizar lista de demandas
            await carregarDemandas();
            
            // MOSTRAR NOTIFICA√á√ÉO PERSONALIZADA
            if (typeof showSuccess === 'function') {
                showSuccess('üéâ Demanda Criada!', 'A demanda foi criada com sucesso e j√° est√° dispon√≠vel no sistema.', 4000);
            } else if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: '‚úÖ Demanda Criada!',
                    text: 'A demanda foi criada com sucesso e j√° est√° dispon√≠vel no sistema.',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK',
                    timer: 3000,
                    timerProgressBar: true
                });
            } else {
                alert('‚úÖ Demanda criada com sucesso!');
            }
            
        } else {
            // Erro
            let mensagemErro = resultado.message || 'Erro ao criar demanda';
            
            if (typeof showError === 'function') {
                showError('‚ùå Erro ao Criar', mensagemErro, 5000);
            } else if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: '‚ùå Erro ao Criar',
                    html: mensagemErro.replace(/\n/g, '<br>'),
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Corrigir'
                });
            } else {
                alert('‚ùå Erro: ' + mensagemErro);
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        
        if (typeof showError === 'function') {
            showError('‚ùå Erro de Conex√£o', 'N√£o foi poss√≠vel conectar ao servidor. Verifique sua conex√£o.', 5000);
        } else if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Erro de Conex√£o',
                text: 'N√£o foi poss√≠vel conectar ao servidor. Verifique sua conex√£o e tente novamente.',
                confirmButtonColor: '#d33',
                confirmButtonText: 'OK'
            });
        } else {
            alert('‚ùå Erro de conex√£o com o servidor');
        }
    } finally {
        // Restaurar bot√£o
        botao.innerHTML = textoOriginal;
        botao.disabled = false;
    }
}

// 4Ô∏è‚É£ NOTIFICA√á√ÉO AO EDITAR COM SUCESSO
async function salvarEdicaoComNotificacao() {
    const form = document.getElementById('formEditarDemanda');
    const botao = document.querySelector('#modalEditarDemanda .btn-warning');
    const id = document.getElementById('editarDemandaId').value;
    
    if (!form || !botao || !id) {
        if (typeof showError === 'function') {
            showError('‚ùå Erro!', 'Dados incompletos para edi√ß√£o', 3000);
        }
        return;
    }
    
    // Validar formul√°rio
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Coletar dados do formul√°rio
    const formData = new FormData(form);
    const dados = Object.fromEntries(formData.entries());
    
    // Remover o campo 'id' dos dados
    const idDemanda = dados.id;
    delete dados.id;
    
    // Salvar texto original do bot√£o
    const textoOriginal = botao.innerHTML;
    
    // Mostrar loading
    botao.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Salvando...';
    botao.disabled = true;
    
    try {
        console.log('üì§ Enviando atualiza√ß√£o:', idDemanda, dados);
        
        // Enviar para API (PUT)
        const response = await fetch(`/api/demandas/${idDemanda}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            // Sucesso!
            
            // Fechar modal
            const modalElement = document.getElementById('modalEditarDemanda');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
            // Atualizar lista de demandas
            await carregarDemandas();
            
            // MOSTRAR NOTIFICA√á√ÉO PERSONALIZADA
            if (typeof showSuccess === 'function') {
                showSuccess('üìù Atualizada!', 'As altera√ß√µes foram salvas com sucesso.', 3000);
            } else if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: '‚úÖ Demanda Atualizada!',
                    text: 'As altera√ß√µes foram salvas com sucesso.',
                    confirmButtonColor: '#3085d6',
                    confirmButtonText: 'OK',
                    timer: 3000,
                    timerProgressBar: true
                });
            } else {
                alert('‚úÖ Demanda atualizada com sucesso!');
            }
            
        } else {
            // Erro
            let mensagemErro = resultado.message || 'Erro ao atualizar demanda';
            
            if (typeof showError === 'function') {
                showError('‚ùå Erro ao Salvar', mensagemErro, 5000);
            } else if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: '‚ùå Erro ao Salvar',
                    html: mensagemErro.replace(/\n/g, '<br>'),
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Corrigir'
                });
            } else {
                alert('‚ùå Erro: ' + mensagemErro);
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
        
        if (typeof showError === 'function') {
            showError('‚ùå Erro de Conex√£o', 'N√£o foi poss√≠vel conectar ao servidor.', 5000);
        } else if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Erro de Conex√£o',
                text: 'N√£o foi poss√≠vel conectar ao servidor. Verifique sua conex√£o e tente novamente.',
                confirmButtonColor: '#d33',
                confirmButtonText: 'OK'
            });
        } else {
            alert('‚ùå Erro de conex√£o com o servidor');
        }
    } finally {
        // Restaurar bot√£o
        botao.innerHTML = textoOriginal;
        botao.disabled = false;
    }
}

// 5Ô∏è‚É£ NOTIFICA√á√ÉO QUANDO A LISTA √â CARREGADA
async function carregarDemandasComNotificacao() {
    const tabela = document.getElementById('tabelaDemandas');
    
    if (!tabela) {
        console.error('Tabela n√£o encontrada');
        return;
    }
    
    // Mostrar loading
    tabela.innerHTML = `
        <tr>
            <td colspan="7" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3 text-muted">Carregando demandas...</p>
            </td>
        </tr>
    `;
    
    try {
        // Buscar demandas da API
        const response = await fetch('/api/demandas');
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        if (resultado.success && resultado.data) {
            todasDemandas = resultado.data;
            renderizarTabela(todasDemandas);
            console.log(`‚úÖ ${todasDemandas.length} demandas carregadas`);
            
            // MOSTRAR NOTIFICA√á√ÉO SUTIL
            if (todasDemandas.length > 0) {
                if (typeof showInfo === 'function') {
                    showInfo('üìä Demandas Carregadas', `${todasDemandas.length} demandas encontradas`, 2000);
                }
            }
        } else {
            throw new Error('Formato de resposta inv√°lido');
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar demandas:', error);
        tabela.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Erro ao carregar demandas</strong>
                        <p class="mb-0 mt-2">${error.message}</p>
                        <button class="btn btn-sm btn-primary mt-3" onclick="carregarDemandasComNotificacao()">
                            <i class="fas fa-redo me-1"></i> Tentar Novamente
                        </button>
                    </div>
                </td>
            </tr>
        `;
        
        // NOTIFICA√á√ÉO DE ERRO
        if (typeof showError === 'function') {
            showError('‚ùå Erro ao Carregar', 'N√£o foi poss√≠vel carregar as demandas: ' + error.message, 5000);
        }
    }
}

// 6Ô∏è‚É£ ATUALIZAR AS FUN√á√ïES ORIGINAIS PARA USAR NOTIFICA√á√ïES
// Substituir as fun√ß√µes originais pelas novas
window.criarDemanda = criarDemandaComNotificacao;
window.salvarEdicaoDemanda = salvarEdicaoComNotificacao;

// Encontrar e substituir a fun√ß√£o excluirDemanda no HTML dos bot√µes
document.addEventListener('DOMContentLoaded', function() {
    // Esta parte ser√° executada depois que a p√°gina carregar
    setTimeout(() => {
        // Substituir todos os bot√µes de excluir para usar a nova fun√ß√£o
        document.addEventListener('click', function(e) {
            if (e.target.closest('.btn-outline-danger')) {
                const button = e.target.closest('.btn-outline-danger');
                const row = button.closest('tr');
                if (row) {
                    // Encontrar o ID da demanda (isso precisa ser adaptado ao seu HTML)
                    // Vamos precisar ajustar isso depois que a tabela for renderizada
                }
            }
        });
        
        console.log('üîî Sistema de notifica√ß√µes integrado na lista de demandas!');
    }, 1000);
});

// 7Ô∏è‚É£ NOTIFICA√á√ÉO DE BOAS-VINDAS
window.addEventListener('load', function() {
    setTimeout(() => {
        if (typeof showInfo === 'function') {
            showInfo('üëã Bem-vindo!', 'Sistema de Demandas Escolares carregado com sucesso!', 3000);
        }
    }, 1000);
});
/* ============================================
   üì± CORRE√á√ÉO COMPLETA DOS MODAIS
   ============================================ */

// 1Ô∏è‚É£ FUN√á√ÉO SEGURA PARA ABRIR MODAL
function abrirModalSeguro(modalId) {
    console.log(`üîì Abrindo modal: ${modalId}`);
    
    // Fechar qualquer modal aberto primeiro (prevenir m√∫ltiplos)
    const modaisAbertos = document.querySelectorAll('.modal.show');
    modaisAbertos.forEach(modal => {
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }
    });
    
    // Pequeno delay para garantir que modais anteriores fechem
    setTimeout(() => {
        const modalElement = document.getElementById(modalId);
        if (!modalElement) {
            console.error(`‚ùå Modal ${modalId} n√£o encontrado`);
            return;
        }
        
        // Criar nova inst√¢ncia do modal
        const modal = new bootstrap.Modal(modalElement, {
            backdrop: true, // Fundo escuro
            keyboard: true, // Fechar com ESC
            focus: true     // Focar no modal
        });
        
        // Configurar eventos para limpeza segura
        modalElement.addEventListener('hidden.bs.modal', function limparModal() {
            console.log(`üîí Fechando modal: ${modalId}`);
            
            // Remover backdrop manualmente se necess√°rio
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                backdrop.remove();
            });
            
            // Remover classes do body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Remover este event listener para evitar duplica√ß√£o
            modalElement.removeEventListener('hidden.bs.modal', limparModal);
        }, { once: true }); // Executar apenas uma vez
        
        // Mostrar o modal
        modal.show();
        
    }, 50); // Pequeno delay
}

// 2Ô∏è‚É£ FUN√á√ÉO PARA FECHAR TODOS OS MODAIS
function fecharTodosModais() {
    console.log('üîí Fechando todos os modais');
    
    // Fechar todas as inst√¢ncias Bootstrap
    const modais = document.querySelectorAll('.modal');
    modais.forEach(modalElement => {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    });
    
    // Limpeza manual garantida
    setTimeout(() => {
        // Remover backdrops
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => {
            backdrop.remove();
        });
        
        // Limpar classes do body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        console.log('‚úÖ Todos os modais fechados e limpos');
    }, 100);
}

// 3Ô∏è‚É£ CSS PARA MODAIS FUNCIONAIS
const modalCSS = `
    /* CORRE√á√ÉO PARA MODAIS QUE N√ÉO FECHAM */
    .modal-backdrop {
        z-index: 1040 !important;
    }
    
    .modal {
        z-index: 1050 !important;
    }
    
    /* Garantir que o modal feche completamente */
    body.modal-open {
        overflow: auto !important;
        padding-right: 0 !important;
    }
    
    /* Bot√µes do modal sempre vis√≠veis */
    .modal-footer {
        background: white;
        position: sticky;
        bottom: 0;
        z-index: 10;
        border-top: 1px solid #dee2e6 !important;
        padding: 1rem !important;
    }
    
    /* Modal scroll√°vel */
    .modal-dialog-scrollable .modal-body {
        max-height: 60vh;
        overflow-y: auto;
    }
    
    /* Em mobile */
    @media (max-width: 768px) {
        .modal-dialog {
            margin: 0.5rem !important;
            max-height: 90vh !important;
        }
        
        .modal-content {
            max-height: 90vh !important;
        }
        
        .modal-body {
            max-height: 70vh !important;
            overflow-y: auto !important;
        }
    }
    
    /* Animar abertura/fechamento */
    .modal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
    }
`;

// Adicionar CSS ao documento
if (!document.querySelector('#modal-fixes-css')) {
    const style = document.createElement('style');
    style.id = 'modal-fixes-css';
    style.textContent = modalCSS;
    document.head.appendChild(style);
}

// 4Ô∏è‚É£ CONFIGURAR TODOS OS BOT√ïES DE MODAL
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Configurando modais...');
    
    // Configurar bot√£o "Nova Demanda"
    const btnNovaDemanda = document.querySelector('[data-bs-target="#novaDemandaModal"]');
    if (btnNovaDemanda) {
        btnNovaDemanda.addEventListener('click', function(e) {
            e.preventDefault();
            abrirModalSeguro('novaDemandaModal');
        });
        console.log('‚úÖ Bot√£o "Nova Demanda" configurado');
    }
    
    // Configurar bot√µes "Cancelar" dos modais
    document.querySelectorAll('.btn-secondary[data-bs-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            // Pequeno delay antes de fechar para evitar conflitos
            setTimeout(() => {
                fecharTodosModais();
            }, 10);
        });
    });
    
    // Configurar bot√£o de fechar (X)
    document.querySelectorAll('.btn-close[data-bs-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            setTimeout(() => {
                fecharTodosModais();
            }, 10);
        });
    });
    
    // Configurar clique fora do modal (backdrop)
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                setTimeout(() => {
                    fecharTodosModais();
                }, 10);
            }
        });
    });
    
    // Bot√£o de emerg√™ncia para limpar tudo
    const limparBtn = document.createElement('button');
    limparBtn.innerHTML = 'üîÑ Limpar Modais';
    limparBtn.className = 'btn btn-sm btn-warning d-none';
    limparBtn.id = 'btn-limpar-modais';
    limparBtn.onclick = fecharTodosModais;
    document.body.appendChild(limparBtn);
    
    console.log('‚úÖ Sistema de modais configurado com seguran√ßa');
});

// 5Ô∏è‚É£ LIMPEZA GLOBAL - Executar se algo der errado
function limparEstadoModal() {
    console.log('üßπ Limpeza de emerg√™ncia dos modais');
    
    // Remover todos os backdrops
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    
    // Remover classes do body
    document.body.classList.remove('modal-open');
    document.body.style.cssText = '';
    
    // Esconder todos os modais
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('show');
        modal.style.cssText = '';
        modal.style.display = 'none';
    });
    
    // For√ßar redraw
    document.body.offsetHeight;
    
    console.log('‚úÖ Estado dos modais limpo');
}

// 6Ô∏è‚É£ EXPOR FUN√á√ïES GLOBAIS
window.abrirModalSeguro = abrirModalSeguro;
window.fecharTodosModais = fecharTodosModais;
window.limparEstadoModal = limparEstadoModal;
</script>
</body>
</html>