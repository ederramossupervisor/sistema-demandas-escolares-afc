<!DOCTYPE html>
<html lang="pt-br" data-bs-theme="light">
<head>
    <%- include('partials/head', {title: 'Alterar Senha - Primeiro Acesso'}) %>
    
    <!-- CSS específico para esta página -->
    <style>
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }
        
        .strength-0 { width: 0%; background-color: #dc3545; }
        .strength-1 { width: 25%; background-color: #dc3545; }
        .strength-2 { width: 50%; background-color: #ffc107; }
        .strength-3 { width: 75%; background-color: #ffc107; }
        .strength-4 { width: 100%; background-color: #28a745; }
        
        .requirement {
            transition: all 0.3s ease;
        }
        
        .requirement.met {
            color: #28a745;
        }
        
        .requirement.not-met {
            color: #6c757d;
        }
        
        .card {
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            border-bottom: none;
            padding: 1.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            border: none;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .user-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navbar -->
    <%- include('partials/navbar') %>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar (minimizada para esta página) -->
            <div class="col-lg-1 col-md-2 d-none d-md-block bg-dark sidebar">
                <div class="sidebar-sticky">
                    <div class="text-center py-4">
                        <i class="bi bi-shield-lock text-white fs-1"></i>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo principal -->
            <main class="col-lg-11 col-md-10 ms-sm-auto px-md-4 py-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-shield-lock me-2"></i>
                        Alteração de Senha - Primeiro Acesso
                    </h1>
                </div>
                
                <!-- Mensagens -->
                <% if (mensagem) { %>
                <div class="alert alert-<%= mensagem.tipo %> alert-dismissible fade show" role="alert">
                    <i class="bi bi-<%= mensagem.tipo === 'success' ? 'check-circle' : 'exclamation-circle' %> me-2"></i>
                    <%= mensagem.texto %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <% } %>
                
                <div class="row justify-content-center">
                    <div class="col-lg-6 col-md-8">
                        <div class="card">
                            <div class="card-header text-center">
                                <h4 class="mb-0">
                                    <i class="bi bi-key me-2"></i>
                                    Crie uma Nova Senha Segura
                                </h4>
                            </div>
                            <div class="card-body p-4">
                                <!-- Informações do usuário -->
                                <div class="user-info">
                                    <div class="row">
                                        <div class="col-3 text-end">
                                            <i class="bi bi-person-circle fs-4 text-primary"></i>
                                        </div>
                                        <div class="col-9">
                                            <h5 class="mb-1"><%= usuario.nome %></h5>
                                            <p class="text-muted mb-0"><%= usuario.email %></p>
                                            <small class="text-warning">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                Primeiro acesso - Senha temporária em uso
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Alerta de segurança -->
                                <div class="alert alert-warning mb-4">
                                    <h5 class="alert-heading">
                                        <i class="bi bi-shield-exclamation me-2"></i>
                                        Importante!
                                    </h5>
                                    <p class="mb-2">Por segurança, você <strong>deve alterar sua senha</strong> antes de acessar o sistema.</p>
                                    <p class="mb-0">Esta senha será usada em todos os seus acessos futuros.</p>
                                </div>
                                
                                <!-- Formulário -->
                                <form id="form-alterar-senha" action="/alterar-senha" method="POST">
                                    <!-- Senha Atual (Temporária) -->
                                    <div class="mb-4">
                                        <label for="senhaAtual" class="form-label">
                                            <i class="bi bi-key-fill me-1"></i>
                                            Senha Atual (Temporária)
                                        </label>
                                        <div class="input-group">
                                            <input 
                                                type="password" 
                                                class="form-control" 
                                                id="senhaAtual" 
                                                name="senhaAtual"
                                                required
                                                placeholder="Digite a senha temporária recebida"
                                            >
                                            <button class="btn btn-outline-secondary" type="button" id="toggleSenhaAtual">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            Digite a senha temporária que você recebeu por e-mail
                                        </div>
                                    </div>
                                    
                                    <!-- Nova Senha -->
                                    <div class="mb-4">
                                        <label for="novaSenha" class="form-label">
                                            <i class="bi bi-lock me-1"></i>
                                            Nova Senha
                                        </label>
                                        <div class="input-group">
                                            <input 
                                                type="password" 
                                                class="form-control" 
                                                id="novaSenha" 
                                                name="novaSenha"
                                                required
                                                placeholder="Digite sua nova senha"
                                            >
                                            <button class="btn btn-outline-secondary" type="button" id="toggleNovaSenha">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="password-strength" id="passwordStrength"></div>
                                        
                                        <!-- Requisitos da senha -->
                                        <div class="mt-3">
                                            <small class="d-block mb-2">A senha deve conter:</small>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="requirement not-met" id="reqLength">
                                                        <i class="bi bi-circle me-1"></i>
                                                        Pelo menos 8 caracteres
                                                    </div>
                                                    <div class="requirement not-met" id="reqUppercase">
                                                        <i class="bi bi-circle me-1"></i>
                                                        Pelo menos 1 letra maiúscula
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="requirement not-met" id="reqLowercase">
                                                        <i class="bi bi-circle me-1"></i>
                                                        Pelo menos 1 letra minúscula
                                                    </div>
                                                    <div class="requirement not-met" id="reqNumber">
                                                        <i class="bi bi-circle me-1"></i>
                                                        Pelo menos 1 número
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Confirmar Nova Senha -->
                                    <div class="mb-4">
                                        <label for="confirmarSenha" class="form-label">
                                            <i class="bi bi-lock-fill me-1"></i>
                                            Confirmar Nova Senha
                                        </label>
                                        <div class="input-group">
                                            <input 
                                                type="password" 
                                                class="form-control" 
                                                id="confirmarSenha" 
                                                name="confirmarSenha"
                                                required
                                                placeholder="Digite novamente a nova senha"
                                            >
                                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmarSenha">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="form-text" id="passwordMatch">
                                            As senhas devem ser iguais
                                        </div>
                                    </div>
                                    
                                    <!-- Botões -->
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                        <a href="/logout" class="btn btn-outline-danger me-md-2">
                                            <i class="bi bi-box-arrow-left me-1"></i>
                                            Sair
                                        </a>
                                        <button type="submit" class="btn btn-primary" id="submitButton" disabled>
                                            <i class="bi bi-check-circle me-1"></i>
                                            Alterar Senha e Acessar Sistema
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <div class="card-footer text-center text-muted">
                                <small>
                                    <i class="bi bi-info-circle me-1"></i>
                                    Após alterar a senha, você será redirecionado automaticamente para o sistema
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- JavaScript específico para validação -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos DOM
            const senhaAtual = document.getElementById('senhaAtual');
            const novaSenha = document.getElementById('novaSenha');
            const confirmarSenha = document.getElementById('confirmarSenha');
            const passwordStrength = document.getElementById('passwordStrength');
            const passwordMatch = document.getElementById('passwordMatch');
            const submitButton = document.getElementById('submitButton');
            
            // Elementos dos requisitos
            const reqLength = document.getElementById('reqLength');
            const reqUppercase = document.getElementById('reqUppercase');
            const reqLowercase = document.getElementById('reqLowercase');
            const reqNumber = document.getElementById('reqNumber');
            
            // Botões para mostrar/ocultar senha
            document.getElementById('toggleSenhaAtual').addEventListener('click', function() {
                togglePasswordVisibility(senhaAtual, this);
            });
            
            document.getElementById('toggleNovaSenha').addEventListener('click', function() {
                togglePasswordVisibility(novaSenha, this);
            });
            
            document.getElementById('toggleConfirmarSenha').addEventListener('click', function() {
                togglePasswordVisibility(confirmarSenha, this);
            });
            
            // Função para mostrar/ocultar senha
            function togglePasswordVisibility(input, button) {
                const icon = button.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                }
            }
            
            // Verificar força da senha em tempo real
            novaSenha.addEventListener('input', function() {
                const password = novaSenha.value;
                
                // Verificar requisitos
                const hasLength = password.length >= 8;
                const hasUppercase = /[A-Z]/.test(password);
                const hasLowercase = /[a-z]/.test(password);
                const hasNumber = /[0-9]/.test(password);
                
                // Atualizar indicadores visuais
                updateRequirement(reqLength, hasLength);
                updateRequirement(reqUppercase, hasUppercase);
                updateRequirement(reqLowercase, hasLowercase);
                updateRequirement(reqNumber, hasNumber);
                
                // Calcular força da senha
                let strength = 0;
                if (hasLength) strength++;
                if (hasUppercase) strength++;
                if (hasLowercase) strength++;
                if (hasNumber) strength++;
                
                // Atualizar barra de força
                passwordStrength.className = 'password-strength strength-' + strength;
                
                // Verificar correspondência com confirmação
                checkPasswordMatch();
                
                // Habilitar/desabilitar botão de envio
                validateForm();
            });
            
            // Verificar se as senhas coincidem
            confirmarSenha.addEventListener('input', checkPasswordMatch);
            
            function checkPasswordMatch() {
                const password = novaSenha.value;
                const confirm = confirmarSenha.value;
                
                if (confirm === '') {
                    passwordMatch.textContent = 'As senhas devem ser iguais';
                    passwordMatch.className = 'form-text';
                    return false;
                }
                
                if (password === confirm) {
                    passwordMatch.innerHTML = '<i class="bi bi-check-circle text-success me-1"></i> Senhas correspondem';
                    passwordMatch.className = 'form-text text-success fw-bold';
                    return true;
                } else {
                    passwordMatch.innerHTML = '<i class="bi bi-x-circle text-danger me-1"></i> Senhas não correspondem';
                    passwordMatch.className = 'form-text text-danger fw-bold';
                    return false;
                }
            }
            
            // Atualizar indicador de requisito
            function updateRequirement(element, met) {
                if (met) {
                    element.className = 'requirement met';
                    element.innerHTML = element.innerHTML.replace('bi-circle', 'bi-check-circle');
                } else {
                    element.className = 'requirement not-met';
                    element.innerHTML = element.innerHTML.replace('bi-check-circle', 'bi-circle');
                }
            }
            
            // Validar formulário completo
            function validateForm() {
                const password = novaSenha.value;
                const confirm = confirmarSenha.value;
                const current = senhaAtual.value;
                
                // Verificar todos os requisitos
                const hasLength = password.length >= 8;
                const hasUppercase = /[A-Z]/.test(password);
                const hasLowercase = /[a-z]/.test(password);
                const hasNumber = /[0-9]/.test(password);
                const passwordsMatch = password === confirm && password !== '';
                const hasCurrentPassword = current !== '';
                
                // Verificar se senha atual não é igual à nova
                const isSameAsCurrent = current === password;
                
                // Habilitar botão se todos os requisitos forem atendidos
                const allValid = hasLength && hasUppercase && hasLowercase && hasNumber && 
                                passwordsMatch && hasCurrentPassword && !isSameAsCurrent;
                
                submitButton.disabled = !allValid;
                
                // Mostrar aviso se senha for igual à atual
                if (isSameAsCurrent && password !== '') {
                    showToast('A nova senha não pode ser igual à senha atual (temporária)', 'warning');
                }
                
                return allValid;
            }
            
            // Adicionar validação para senha atual também
            senhaAtual.addEventListener('input', validateForm);
            
            // Função para mostrar toast (se necessário)
            function showToast(message, type = 'info') {
                // Implementação básica - você pode integrar com seu sistema de notificações
                alert(message);
            }
            
            // Prevenir envio se formulário não for válido
            document.getElementById('form-alterar-senha').addEventListener('submit', function(e) {
                if (!validateForm()) {
                    e.preventDefault();
                    showToast('Por favor, corrija os erros no formulário antes de enviar.', 'error');
                }
            });
            
            // Focar no primeiro campo
            senhaAtual.focus();
        });
    </script>
</body>
</html>